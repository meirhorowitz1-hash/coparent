
  <ion-header>
    <ion-toolbar>
      <ion-title>פרופיל</ion-title>
    </ion-toolbar>
  </ion-header>

  <ion-content [fullscreen]="true">
  <ng-container *ngIf="profile$ | async as profile; else loadingState">
    <div class="profile-layout">
      <section class="profile-card panel">
        <div class="profile-hero">
          <div class="avatar-ring">
            <ion-icon name="person-outline"></ion-icon>
          </div>
          <div>
            <p class="eyebrow">הפרופיל שלי</p>
            <h1>{{ profile?.fullName || 'משתמש חדש' }}</h1>
            <p class="email">{{ profile?.email }}</p>
            <p class="phone" *ngIf="profile?.phone">טלפון: {{ profile.phone }}</p>
          </div>
        </div>
        <p class="hint">עדכן את הפרטים שלך בקרוב. בינתיים ניתן להזמין שותף/ה לחשבון.</p>
      </section>

      <section class="family-card panel">
        <header>
          <div>
            <h2>שותפות הורות</h2>
            <p>שתפו בן/בת זוג כדי לנהל יחד לוח שנה, משימות והוצאות.</p>
          </div>
        </header>

        <div class="family-status" *ngIf="family$ | async as family">
          <div class="status-row" [class.connected]="(family?.members?.length ?? 0) > 1">
            <ion-icon [name]="(family?.members?.length ?? 0) > 1 ? 'people-outline' : 'person-add-outline'"></ion-icon>
            <div>
              <strong *ngIf="(family?.members?.length ?? 0) > 1">
                {{ family?.members?.length }} הורים מחוברים לחשבון הזה
              </strong>
              <strong *ngIf="(family?.members?.length ?? 0) <= 1">
                עדיין אין שותף לחשבון
              </strong>
              <p>
                {{
                  (family?.members?.length ?? 0) > 1
                    ? 'כל הנתונים מסתנכרנים בין כל בני המשפחה.'
                    : 'שלחו הזמנה כדי לשתף את בן/בת הזוג בכל מה שקורה.'
                }}
              </p>
            </div>
          </div>

          <form class="household-info panel-lite" [formGroup]="householdForm" (ngSubmit)="saveHouseholdMeta()">
            <div class="info-block">
              <p class="eyebrow">שם המרחב</p>
              <h3>{{ family?.name || 'מרחב משותף' }}</h3>
              <ion-item lines="none" class="inline-input">
                <ion-input formControlName="name" placeholder="תנו שם למרחב"></ion-input>
              </ion-item>
            </div>
            <div class="info-block">
              <p class="eyebrow">ילדים</p>
              <div class="chips" *ngIf="householdChildren.length; else noKids">
                <ion-chip *ngFor="let kid of householdChildren" (click)="removeChild(kid)">
                  <ion-label>{{ kid }}</ion-label>
                  <ion-icon name="close"></ion-icon>
                </ion-chip>
              </div>
              <ng-template #noKids>
                <p class="helper">לא הוזנו ילדים במרחב</p>
              </ng-template>
              <div class="inline-input">
                <ion-input formControlName="childName" placeholder="שם ילד/ה"></ion-input>
                <ion-button size="small" fill="clear" type="button" (click)="addChild()">הוספה</ion-button>
              </div>
              <ion-button expand="block" size="small" (click)="saveHouseholdMeta()" [disabled]="isSavingHousehold">
                {{ isSavingHousehold ? 'שומר...' : 'שמור פרטים' }}
              </ion-button>
            </div>
          </form>

          <div class="leave-family" *ngIf="family?.id">
            <button type="button" class="ghost danger" (click)="leaveFamily()" [disabled]="isLeavingFamily">
              <ion-icon name="exit-outline"></ion-icon>
              <span>{{ isLeavingFamily ? 'מתנתק...' : 'התנתק מהמשפחה הזו' }}</span>
            </button>
            <p class="helper">
              פעולה זו תסיר את החשבון שלך מהמשפחה הפעילה. ניתן להצטרף מחדש בעזרת קוד חדש או הזמנה.
            </p>
            <div
              class="leave-message"
              *ngIf="leaveFamilyMessage"
              [class.success]="leaveFamilyMessage.type === 'success'"
              [class.error]="leaveFamilyMessage.type === 'error'">
              <ion-icon [name]="leaveFamilyMessage.type === 'success' ? 'checkmark-circle-outline' : 'alert-circle-outline'"></ion-icon>
              <span>{{ leaveFamilyMessage.text }}</span>
            </div>
          </div>

          <div class="pending" *ngIf="family?.pendingInvites?.length">
            <h3>הזמנות ממתינות</h3>
            <ul>
              <li *ngFor="let invite of family.pendingInvites; trackBy: trackInvite">
                <div>
                  <span>{{ invite.displayEmail }}</span>
                  <small>נשלחה בתאריך {{ invite.createdAt | date: 'dd/MM/yy HH:mm' }}</small>
                </div>
                <span class="badge">ממתין להצטרפות</span>
              </li>
            </ul>
          </div>
        </div>

        <div class="share-code">
          <label>קוד שיתוף</label>
          <ng-container *ngIf="shareCode; else createShareCode">
            <div class="code-wrapper">
              <span class="code">{{ shareCode }}</span>
              <div class="code-actions">
                <button type="button" (click)="copyShareCode()">
                  <ion-icon name="copy-outline"></ion-icon>
                  <span>העתק</span>
                </button>
                <button
                  type="button"
                  class="ghost"
                  (click)="regenerateShareCode()"
                  [disabled]="isGeneratingShareCode"
                >
                  <ion-icon name="refresh-outline"></ion-icon>
                  <span>קוד חדש</span>
                </button>
              </div>
            </div>
            <p class="helper">
              שלחו את הקוד להורה נוסף. ברגע שיכניס אותו בפרופיל שלו, הוא יצטרף למידע שלכם.
            </p>
            <p class="link-feedback success" *ngIf="shareCodeCopied">הקוד הועתק ללוח</p>
            <p class="link-feedback error" *ngIf="shareCodeError">{{ shareCodeError }}</p>
          </ng-container>
          <ng-template #createShareCode>
            <button type="button" class="primary" (click)="createFamilySpace()" [disabled]="isGeneratingShareCode">
              <ion-spinner *ngIf="isGeneratingShareCode" name="crescent"></ion-spinner>
              <span *ngIf="!isGeneratingShareCode">יצירת קוד שיתוף</span>
            </button>
            <p class="helper">
              ניצור עבורך קבוצה משותפת וקוד להצטרפות ההורה השני.
            </p>
            <p class="link-feedback error" *ngIf="shareCodeError">{{ shareCodeError }}</p>
          </ng-template>
        </div>



        <form class="join-code-form" [formGroup]="familyCodeForm" (ngSubmit)="joinByCode()">
          <label for="familyCode">יש קוד שיתוף? הזינו אותו כאן</label>
          <div class="input-wrapper" [class.invalid]="familyCodeForm.get('code')?.invalid && familyCodeForm.get('code')?.touched">
            <ion-icon name="key-outline"></ion-icon>
            <input
              id="familyCode"
              type="text"
              formControlName="code"
              placeholder="123456"
              autocomplete="off"
              inputmode="numeric"
            />
            <button type="submit" [disabled]="isJoiningByCode">
              <ion-spinner *ngIf="isJoiningByCode" name="crescent"></ion-spinner>
              <span *ngIf="!isJoiningByCode">הצטרף</span>
            </button>
          </div>
          <p class="error" *ngIf="familyCodeForm.get('code')?.invalid && familyCodeForm.get('code')?.touched">
            הזינו קוד בן 6 ספרות
          </p>
        </form>

        <div
          class="join-message"
          *ngIf="joinCodeMessage"
          [class.success]="joinCodeMessage.type === 'success'"
          [class.error]="joinCodeMessage.type === 'error'"
        >
          <ion-icon [name]="joinCodeMessage.type === 'success' ? 'checkmark-circle-outline' : 'alert-circle-outline'"></ion-icon>
          <span>{{ joinCodeMessage.text }}</span>
        </div>

        <div class="family-list" *ngIf="familiesList.length > 1">
          <h3>משפחות מחוברות</h3>
          <ul>
            <li *ngFor="let familyId of familiesList">
              <div>
                <span>{{ familyId }}</span>
                <small *ngIf="profile?.activeFamilyId === familyId">משפחה פעילה</small>
              </div>
              <button
                type="button"
                class="ghost"
                (click)="setActiveFamily(familyId)"
                [disabled]="familyId === profile?.activeFamilyId || switchingFamilyId === familyId"
              >
                <ion-spinner *ngIf="switchingFamilyId === familyId" name="crescent"></ion-spinner>
                <span *ngIf="switchingFamilyId !== familyId">הפוך לפעילה</span>
              </button>
            </li>
          </ul>
        </div>

        <div
          class="invite-message"
          *ngIf="inviteMessage"
          [class.success]="inviteMessage.type === 'success'"
          [class.error]="inviteMessage.type === 'error'"
        >
          <ion-icon [name]="inviteMessage.type === 'success' ? 'checkmark-circle-outline' : 'alert-circle-outline'"></ion-icon>
          <span>{{ inviteMessage.text }}</span>
        </div>

        <div class="signout-block">
          <button type="button" class="danger" (click)="signOut()" [disabled]="isSigningOut">
            <ion-icon name="log-out-outline" *ngIf="!isSigningOut"></ion-icon>
            <ion-spinner *ngIf="isSigningOut" name="crescent"></ion-spinner>
            <span>{{ isSigningOut ? 'מתנתק...' : 'יציאה מהחשבון' }}</span>
          </button>
          <p class="signout-error" *ngIf="signOutError">{{ signOutError }}</p>
        </div>
      </section>
    </div>
  </ng-container>

  <ng-template #loadingState>
    <div class="loading-state">
      <ion-spinner name="crescent"></ion-spinner>
    </div>
  </ng-template>
</ion-content>
