
<ion-header>
  <ion-toolbar>
    <ion-title>{{ 'profile.title' | t }}</ion-title>
  </ion-toolbar>
</ion-header>

  <ion-content [fullscreen]="true">
  <ng-container *ngIf="profile$ | async as profile; else loadingState">
    <div class="profile-layout">
      <section class="panel language-card">
        <header>
          <div>
            <h2>{{ 'language.settings.title' | t }}</h2>
            <p class="helper">{{ 'language.settings.description' | t }}</p>
          </div>
        </header>
        <ion-segment [value]="currentLanguage">
          <ion-segment-button value="he" (click)="onLanguageChange('he')">
            <ion-label>{{ 'language.settings.he' | t }}</ion-label>
          </ion-segment-button>
          <ion-segment-button value="en" (click)="onLanguageChange('en')">
            <ion-label>{{ 'language.settings.en' | t }}</ion-label>
          </ion-segment-button>
        </ion-segment>
      </section>

     

      <section class="profile-card panel">
        <div class="profile-hero">
          <div
            class="avatar-ring"
            [class.editable]="isEditingProfile"
            (click)="onAvatarRingClick(avatarInput)"
            [title]="isEditingProfile ? ('profile.uploadHint' | t) : ''">
            <img
              *ngIf="avatarPreviewUrl"
              [src]="avatarPreviewUrl"
              alt="תמונת פרופיל" />
            <ion-icon *ngIf="!avatarPreviewUrl" name="person-outline"></ion-icon>
            <div class="avatar-overlay" *ngIf="isEditingProfile">
              <ion-icon name="camera"></ion-icon>
              <span class="overlay-hint">{{ 'profile.uploadHint' | t }}</span>
            </div>
          </div>
          <input
            #avatarInput
            type="file"
            accept="image/*"
            hidden
            (change)="onAvatarFileSelected($event)" />
          <div>
            <p class="eyebrow">{{ 'profile.myProfile' | t }}</p>
            <h1>{{ profile?.fullName || ('profile.newUser' | t) }}</h1>
            <p class="email">{{ profile?.email }}</p>
            <p class="phone" *ngIf="profile?.phone">{{ 'profile.phone' | t }}: {{ profile.phone }}</p>
          </div>
          <button
            class="edit-toggle"
            [class.edit-toggle-rtl]="isRtl"
            type="button"
            (click)="isEditingProfile ? cancelProfileEdit() : startProfileEdit()"
            [attr.title]="isEditingProfile ? ('profile.button.cancelEdit' | t) : ('profile.button.edit' | t)"
            aria-label="{{ isEditingProfile ? ('profile.button.cancelEdit' | t) : ('profile.button.edit' | t) }}">
            <ion-icon [name]="isEditingProfile ? 'close-outline' : 'create-outline'"></ion-icon>
          </button>
        </div>
        <p class="avatar-error" *ngIf="avatarError">{{ avatarError }}</p>
        <div class="profile-body" *ngIf="!isEditingProfile">
          <p class="hint">{{ 'profile.editHint' | t }}</p>
          <div class="profile-colors">
            <div class="profile-color">
              <span class="color-dot" [style.background]="parentColors.parent1"></span>
              <span>{{ parentLabels.parent1 }}</span>
            </div>
            <div class="profile-color">
              <span class="color-dot" [style.background]="parentColors.parent2"></span>
              <span>{{ parentLabels.parent2 }}</span>
            </div>
          </div>
        </div>
        <form class="profile-edit" *ngIf="isEditingProfile" [formGroup]="profileEditForm" (ngSubmit)="saveProfile()">
          <ion-item lines="none" class="inline-input">
            <ion-input formControlName="fullName" [placeholder]="'profile.fullNamePlaceholder' | t"></ion-input>
          </ion-item>
          <ion-button expand="block" type="submit" [disabled]="isSavingProfile">
            {{ isSavingProfile ? ('profile.savingProfile' | t) : ('profile.saveProfile' | t) }}
          </ion-button>
        </form>
      </section>

      <section class="family-card panel">
        <header>
          <div>
            <h2>{{ 'profile.coParenting' | t }}</h2>
            <p>{{ 'profile.coParenting.helper' | t }}</p>
          </div>
        </header>

        <ng-container *ngIf="family$ | async as family; else noFamilyState">
          <div class="family-profile-card" [class.editing]="isEditingFamilyMeta">
            <div class="family-profile-hero">
                <div class="avatar-ring family">
                <ion-icon name="home-outline"></ion-icon>
              </div>
              <div class="family-summary">
                <p class="eyebrow">{{ 'profile.spaceProfile' | t }}</p>
                <h1 class="family-title">{{ family?.name || ('profile.spaceNoName' | t) }}</h1>
                <p class="children-line"> 
                 {{ 'profile.childrenLabel' | t }}
                 {{ householdChildren?.length ? householdChildren.join(', ') : ('profile.noChildren' | t) }}
                </p>
              </div>
            
              <button
                type="button"
                class="edit-toggle"
                (click)="isEditingFamilyMeta ? cancelFamilyEdit() : startFamilyEdit()"
                
              >
                <ion-icon [name]="isEditingFamilyMeta ? 'close-outline' : 'create-outline'"></ion-icon>
              </button>
            </div>

            <form
              class="household-form"
              [formGroup]="householdForm"
              (ngSubmit)="saveHouseholdMeta()"
              *ngIf="isEditingFamilyMeta"
            >
              <label class="field-label">{{ 'profile.spaceName' | t }}</label>
              <ion-item lines="none" class="inline-input prominent">
                <ion-input formControlName="name" [placeholder]="'profile.spaceNamePlaceholder' | t"></ion-input>
              </ion-item>

              <label class="field-label with-space">{{ 'profile.childrenLabel' | t }}</label>
              <div class="chips" *ngIf="householdChildren.length; else noKidsEdit">
                <ion-chip *ngFor="let kid of householdChildren" (click)="removeChild(kid)">
                  <ion-label>{{ kid }}</ion-label>
                  <ion-icon name="close"></ion-icon>
                </ion-chip>
              </div>
              <ng-template #noKidsEdit>
                <p class="helper">{{ 'profile.childrenHelper' | t }}</p>
              </ng-template>

              <div class="inline-input add-child">
                <ion-input formControlName="childName" [placeholder]="'profile.childPlaceholder' | t"></ion-input>
                <ion-button size="small" fill="solid" type="button" (click)="addChild()">{{ 'profile.addChild' | t }}</ion-button>
              </div>

              <ion-button expand="block" class="save-household" type="submit" [disabled]="isSavingHousehold">
                {{ isSavingHousehold ? ('profile.saving' | t) : ('profile.saveHousehold' | t) }}
              </ion-button>
            </form>
          </div>

          <div class="family-status">
            <div class="members-accordion">
              <button class="accordion-header" type="button" (click)="showMembersAccordion = !showMembersAccordion">
                <div>
                  <p class="title">
                    {{ getMembersTitle(family?.members?.length || 0) }}
                  </p>
                  <p class="subtitle">
                    {{ getMembersSubtitle(family?.members?.length || 0) }}
                  </p>
                </div>
                <ion-icon [name]="showMembersAccordion ? 'chevron-up-outline' : 'people-outline'"></ion-icon>
              </button>
              <div class="accordion-body" *ngIf="showMembersAccordion && memberProfiles.length">
                <ul>
                  <li *ngFor="let member of memberProfiles">
                    <div class="member-avatar">
                      <img *ngIf="member.photoUrl" [src]="member.photoUrl" alt="avatar" />
                      <ion-icon *ngIf="!member.photoUrl" name="person-circle-outline"></ion-icon>
                    </div>
                    <span>{{ member.name }}</span>
                  </li>
                </ul>
              </div>
            </div>
     <app-storage-usage [showBreakdown]="true"></app-storage-usage>
            <div class="pending" *ngIf="family?.pendingInvites?.length">
              <h3>{{ 'profile.pendingInvites' | t }}</h3>
              <ul>
                <li *ngFor="let invite of family.pendingInvites; trackBy: trackInvite">
                  <div>
                    <span>{{ invite.displayEmail }}</span>
                    <small>{{ 'profile.inviteSentAt' | t:{ date: (invite.createdAt | date:'dd/MM/yy HH:mm') || '' } }}</small>
                  </div>
                  <span class="badge">{{ 'profile.invitePending' | t }}</span>
                </li>
              </ul>
            </div>
          </div>
        </ng-container>

        <div class="family-switcher" *ngIf="familyOptions.length">
          <div class="switcher-header">
            <p class="eyebrow">{{ 'profile.switcher.title' | t }}</p>
            <p class="helper">{{ 'profile.switcher.helper' | t }}</p>
          </div>
          <div class="switcher-options">
            <div
              class="family-option"
              *ngFor="let fam of familyOptions"
              [class.active]="profile?.activeFamilyId === fam.id"
            >
              <button
                type="button"
                class="select"
                (click)="setActiveFamily(fam.id)"
                [disabled]="profile?.activeFamilyId === fam.id || switchingFamilyId === fam.id || leavingFamilyId === fam.id"
              >
                <ion-icon name="home-outline"></ion-icon>
                <div class="label">
                  <span>{{ fam.name }}</span>
                  <small *ngIf="profile?.activeFamilyId === fam.id">{{ 'profile.activeFamily' | t }}</small>
                </div>
                <ion-spinner *ngIf="switchingFamilyId === fam.id" name="crescent"></ion-spinner>
              </button>
              <button
                type="button"
                class="leave"
                (click)="onLeaveFamilyClick($event, fam.id)"
                [disabled]="leavingFamilyId === fam.id || isLeavingFamily"
              >
                <ion-icon *ngIf="leavingFamilyId !== fam.id" name="exit-outline"></ion-icon>
                <ion-spinner *ngIf="leavingFamilyId === fam.id" name="crescent"></ion-spinner>
              </button>
            </div>
          </div>
        </div>

        <ng-template #noFamilyState>
          <div class="family-choice">
            <p class="eyebrow">{{ 'profile.noFamilySelected' | t }}</p>
            <h3>{{ 'profile.joinOrCreate' | t }}</h3>
            <p class="helper">
              {{ 'profile.joinHelper' | t }}
            </p>
            <div class="choice-actions">
              <button type="button" class="primary" (click)="scrollToJoinSection()">{{ 'profile.joinWithCode' | t }}</button>
              <button
                type="button"
                class="ghost"
                (click)="createFamilySpace()"
                [disabled]="isGeneratingShareCode"
              >
                <ion-spinner *ngIf="isGeneratingShareCode" name="crescent"></ion-spinner>
                <span *ngIf="!isGeneratingShareCode">{{ 'profile.createSpace' | t }}</span>
              </button>
            </div>
          </div>
        </ng-template>

        <div class="share-code" *ngIf="isShareOwner">
          <label>{{ 'profile.shareCode' | t }}</label>
          <ng-container *ngIf="shareCode">
            <div class="code-wrapper">
              <span class="code">{{ shareCode }}</span>
              <div class="code-actions">
                <button type="button" (click)="copyShareCode()">
                  <ion-icon name="copy-outline"></ion-icon>
                  <span>{{ 'profile.copy' | t }}</span>
                </button>
                <button
                  type="button"
                  class="ghost"
                  (click)="regenerateShareCode()"
                  [disabled]="isGeneratingShareCode"
                >
                  <ion-icon name="refresh-outline"></ion-icon>
                  <span>{{ 'profile.newCode' | t }}</span>
                </button>
              </div>
            </div>
            <p class="helper">
              {{ 'profile.shareHelper' | t }}
            </p>
            <p class="link-feedback success" *ngIf="shareCodeCopied">{{ 'profile.codeCopied' | t }}</p>
            <p class="link-feedback error" *ngIf="shareCodeError">{{ shareCodeError }}</p>
          </ng-container>
        </div>

        <form class="join-code-form" id="join-by-code" [formGroup]="familyCodeForm" (ngSubmit)="joinByCode()">
          <label for="familyCode">{{ 'profile.enterShareCode' | t }}</label>
          <div class="input-wrapper" [class.invalid]="familyCodeForm.get('code')?.invalid && familyCodeForm.get('code')?.touched">
            <ion-icon name="key-outline"></ion-icon>
            <input
              id="familyCode"
              type="text"
              formControlName="code"
              placeholder="123456"
              autocomplete="off"
              inputmode="numeric"
            />
            <button type="submit" [disabled]="isJoiningByCode">
              <ion-spinner *ngIf="isJoiningByCode" name="crescent"></ion-spinner>
              <span *ngIf="!isJoiningByCode">{{ 'profile.join' | t }}</span>
            </button>
          </div>
          <p class="error" *ngIf="familyCodeForm.get('code')?.invalid && familyCodeForm.get('code')?.touched">
            {{ 'profile.joinCodeError' | t }}
          </p>
        </form>

        <div
          class="join-message"
          *ngIf="joinCodeMessage"
          [class.success]="joinCodeMessage.type === 'success'"
          [class.error]="joinCodeMessage.type === 'error'"
        >
          <ion-icon [name]="joinCodeMessage.type === 'success' ? 'checkmark-circle-outline' : 'alert-circle-outline'"></ion-icon>
          <span>{{ joinCodeMessage.text }}</span>
        </div>

        <div
          class="invite-message"
          *ngIf="inviteMessage"
          [class.success]="inviteMessage.type === 'success'"
          [class.error]="inviteMessage.type === 'error'"
        >
          <ion-icon [name]="inviteMessage.type === 'success' ? 'checkmark-circle-outline' : 'alert-circle-outline'"></ion-icon>
          <span>{{ inviteMessage.text }}</span>
        </div>

        <div class="signout-block">
          <button type="button" class="danger" (click)="signOut()" [disabled]="isSigningOut">
            <ion-icon name="log-out-outline" *ngIf="!isSigningOut"></ion-icon>
            <ion-spinner *ngIf="isSigningOut" name="crescent"></ion-spinner>
            <span>{{ isSigningOut ? ('profile.signingOut' | t) : ('profile.signout' | t) }}</span>
          </button>
          <p class="signout-error" *ngIf="signOutError">{{ signOutError }}</p>
        </div>
      </section>
  
    </div>
  </ng-container>

  <ng-template #loadingState>
    <div class="loading-state">
      <ion-spinner name="crescent"></ion-spinner>
    </div>
  </ng-template>
</ion-content>
