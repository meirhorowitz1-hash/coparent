
  <ion-header>
    <ion-toolbar>
      <ion-title>פרופיל</ion-title>
    </ion-toolbar>
  </ion-header>

  <ion-content [fullscreen]="true">
  <ng-container *ngIf="profile$ | async as profile; else loadingState">
    <div class="profile-layout">
      <section class="profile-card panel">
        <div class="profile-hero">
          <div class="avatar-ring">
            <ion-icon name="person-outline"></ion-icon>
          </div>
          <div>
            <p class="eyebrow">הפרופיל שלי</p>
            <h1>{{ profile?.fullName || 'משתמש חדש' }}</h1>
            <p class="email">{{ profile?.email }}</p>
            <p class="phone" *ngIf="profile?.phone">טלפון: {{ profile.phone }}</p>
          </div>
          <button class="edit-toggle" type="button" (click)="isEditingProfile ? cancelProfileEdit() : startProfileEdit()">
            <ion-icon [name]="isEditingProfile ? 'close-outline' : 'create-outline'"></ion-icon>
          </button>
        </div>
        <div class="profile-body" *ngIf="!isEditingProfile">
          <p class="hint">עדכן את הפרטים שלך בקרוב. בינתיים ניתן להזמין שותף/ה לחשבון.</p>
          <div class="profile-colors">
            <div class="profile-color">
              <span class="color-dot" [style.background]="parentColors.parent1"></span>
              <span>{{ parentLabels.parent1 }}</span>
            </div>
            <div class="profile-color">
              <span class="color-dot" [style.background]="parentColors.parent2"></span>
              <span>{{ parentLabels.parent2 }}</span>
            </div>
          </div>
        </div>
        <form class="profile-edit" *ngIf="isEditingProfile" [formGroup]="profileEditForm" (ngSubmit)="saveProfile()">
          <ion-item lines="none" class="inline-input">
            <ion-input formControlName="fullName" placeholder="שם מלא"></ion-input>
          </ion-item>
          <ion-item lines="none" class="inline-input">
            <ion-input formControlName="photoUrl" placeholder="קישור לתמונת פרופיל"></ion-input>
          </ion-item>
          <ion-button expand="block" type="submit" [disabled]="isSavingProfile">
            {{ isSavingProfile ? 'שומר...' : 'שמור פרופיל' }}
          </ion-button>
        </form>
      </section>

      <section class="family-card panel">
        <header>
          <div>
            <h2>שותפות הורות</h2>
            <p>שתפו בן/בת זוג כדי לנהל יחד לוח שנה, משימות והוצאות.</p>
          </div>
        </header>

        <ng-container *ngIf="family$ | async as family; else noFamilyState">
          <div class="family-profile-card" [class.editing]="isEditingFamilyMeta">
            <div class="family-profile-hero">
                <div class="avatar-ring family">
                <ion-icon name="home-outline"></ion-icon>
              </div>
              <div class="family-summary">
                <p class="eyebrow">פרופיל המרחב</p>
                <h1 class="family-title">{{ family?.name || 'מרחב ללא שם' }}</h1>
                <p class="children-line"> 
                 ילדים: {{ householdChildren?.length ? householdChildren.join(', ') : 'אין ילדים במרחב' }}
                </p>
              </div>
            
              <button
                type="button"
                class="edit-toggle"
                (click)="isEditingFamilyMeta ? cancelFamilyEdit() : startFamilyEdit()"
              >
                <ion-icon [name]="isEditingFamilyMeta ? 'close-outline' : 'create-outline'"></ion-icon>
              </button>
            </div>

            <form
              class="household-form"
              [formGroup]="householdForm"
              (ngSubmit)="saveHouseholdMeta()"
              *ngIf="isEditingFamilyMeta"
            >
              <label class="field-label">שם המרחב</label>
              <ion-item lines="none" class="inline-input prominent">
                <ion-input formControlName="name" placeholder="לדוגמה: המשפחה שלנו"></ion-input>
              </ion-item>

              <label class="field-label with-space">ילדים</label>
              <div class="chips" *ngIf="householdChildren.length; else noKidsEdit">
                <ion-chip *ngFor="let kid of householdChildren" (click)="removeChild(kid)">
                  <ion-label>{{ kid }}</ion-label>
                  <ion-icon name="close"></ion-icon>
                </ion-chip>
              </div>
              <ng-template #noKidsEdit>
                <p class="helper">עוד לא הוזנו ילדים במרחב.</p>
              </ng-template>

              <div class="inline-input add-child">
                <ion-input formControlName="childName" placeholder="שם ילד/ה"></ion-input>
                <ion-button size="small" fill="solid" type="button" (click)="addChild()">הוספה</ion-button>
              </div>

              <ion-button expand="block" class="save-household" type="submit" [disabled]="isSavingHousehold">
                {{ isSavingHousehold ? 'שומר...' : 'שמור פרטים' }}
              </ion-button>
            </form>
          </div>

          <div class="family-status">
            <div class="members-accordion">
              <button class="accordion-header" type="button" (click)="showMembersAccordion = !showMembersAccordion">
                <div>
                  <p class="title">
                    {{
                      (family?.members?.length ?? 0) > 1
                        ? (family?.members?.length || 0) + ' הורים מחוברים לחשבון הזה'
                        : 'עדיין אין שותף לחשבון'
                    }}
                  </p>
                  <p class="subtitle">
                    {{
                      (family?.members?.length ?? 0) > 1
                        ? 'כל הנתונים מסתנכרנים בין כל בני המשפחה.'
                        : 'שלחו הזמנה כדי לשתף את בן/בת הזוג בכל מה שקורה.'
                    }}
                  </p>
                </div>
                <ion-icon [name]="showMembersAccordion ? 'chevron-up-outline' : 'people-outline'"></ion-icon>
              </button>
              <div class="accordion-body" *ngIf="showMembersAccordion && memberNames.length">
                <ul>
                  <li *ngFor="let name of memberNames">
                    <ion-icon name="person-circle-outline"></ion-icon>
                    <span>{{ name }}</span>
                  </li>
                </ul>
              </div>
            </div>

            <div class="pending" *ngIf="family?.pendingInvites?.length">
              <h3>הזמנות ממתינות</h3>
              <ul>
                <li *ngFor="let invite of family.pendingInvites; trackBy: trackInvite">
                  <div>
                    <span>{{ invite.displayEmail }}</span>
                    <small>נשלחה בתאריך {{ invite.createdAt | date: 'dd/MM/yy HH:mm' }}</small>
                  </div>
                  <span class="badge">ממתין להצטרפות</span>
                </li>
              </ul>
            </div>
          </div>
        </ng-container>

        <div class="family-switcher" *ngIf="familyOptions.length">
          <div class="switcher-header">
            <p class="eyebrow">בחירת מרחב פעיל</p>
            <p class="helper">בחרו באיזה מרחב לעבוד כרגע. הפעיל ישמש לסנכרון לוח שנה, משימות והוצאות.</p>
          </div>
          <div class="switcher-options">
            <div
              class="family-option"
              *ngFor="let fam of familyOptions"
              [class.active]="profile?.activeFamilyId === fam.id"
            >
              <button
                type="button"
                class="select"
                (click)="setActiveFamily(fam.id)"
                [disabled]="profile?.activeFamilyId === fam.id || switchingFamilyId === fam.id || leavingFamilyId === fam.id"
              >
                <ion-icon name="home-outline"></ion-icon>
                <div class="label">
                  <span>{{ fam.name }}</span>
                  <small *ngIf="profile?.activeFamilyId === fam.id">משפחה פעילה</small>
                </div>
                <ion-spinner *ngIf="switchingFamilyId === fam.id" name="crescent"></ion-spinner>
              </button>
              <button
                type="button"
                class="leave"
                (click)="onLeaveFamilyClick($event, fam.id)"
                [disabled]="leavingFamilyId === fam.id || isLeavingFamily"
              >
                <ion-icon *ngIf="leavingFamilyId !== fam.id" name="exit-outline"></ion-icon>
                <ion-spinner *ngIf="leavingFamilyId === fam.id" name="crescent"></ion-spinner>
              </button>
            </div>
          </div>
        </div>

        <ng-template #noFamilyState>
          <div class="family-choice">
            <p class="eyebrow">לא בחרתם מרחב עדיין</p>
            <h3>הצטרפו למרחב קיים או צרו חדש</h3>
            <p class="helper">
              אפשר להצטרף עם קוד שהתקבל מהורה אחר, או לפתוח מרחב חדש ולשתף אותו אחרי ההרשמה.
            </p>
            <div class="choice-actions">
              <button type="button" class="primary" (click)="scrollToJoinSection()">יש לי קוד הצטרפות</button>
              <button
                type="button"
                class="ghost"
                (click)="createFamilySpace()"
                [disabled]="isGeneratingShareCode"
              >
                <ion-spinner *ngIf="isGeneratingShareCode" name="crescent"></ion-spinner>
                <span *ngIf="!isGeneratingShareCode">יצירת מרחב חדש</span>
              </button>
            </div>
          </div>
        </ng-template>

        <div class="share-code" *ngIf="isShareOwner">
          <label>קוד שיתוף</label>
          <ng-container *ngIf="shareCode">
            <div class="code-wrapper">
              <span class="code">{{ shareCode }}</span>
              <div class="code-actions">
                <button type="button" (click)="copyShareCode()">
                  <ion-icon name="copy-outline"></ion-icon>
                  <span>העתק</span>
                </button>
                <button
                  type="button"
                  class="ghost"
                  (click)="regenerateShareCode()"
                  [disabled]="isGeneratingShareCode"
                >
                  <ion-icon name="refresh-outline"></ion-icon>
                  <span>קוד חדש</span>
                </button>
              </div>
            </div>
            <p class="helper">
              שלחו את הקוד להורה נוסף. ברגע שיכניס אותו בפרופיל שלו, הוא יצטרף למידע שלכם.
            </p>
            <p class="link-feedback success" *ngIf="shareCodeCopied">הקוד הועתק ללוח</p>
            <p class="link-feedback error" *ngIf="shareCodeError">{{ shareCodeError }}</p>
          </ng-container>
        </div>

        <form class="join-code-form" id="join-by-code" [formGroup]="familyCodeForm" (ngSubmit)="joinByCode()">
          <label for="familyCode">יש קוד שיתוף? הזינו אותו כאן</label>
          <div class="input-wrapper" [class.invalid]="familyCodeForm.get('code')?.invalid && familyCodeForm.get('code')?.touched">
            <ion-icon name="key-outline"></ion-icon>
            <input
              id="familyCode"
              type="text"
              formControlName="code"
              placeholder="123456"
              autocomplete="off"
              inputmode="numeric"
            />
            <button type="submit" [disabled]="isJoiningByCode">
              <ion-spinner *ngIf="isJoiningByCode" name="crescent"></ion-spinner>
              <span *ngIf="!isJoiningByCode">הצטרף</span>
            </button>
          </div>
          <p class="error" *ngIf="familyCodeForm.get('code')?.invalid && familyCodeForm.get('code')?.touched">
            הזינו קוד בן 6 ספרות
          </p>
        </form>

        <div
          class="join-message"
          *ngIf="joinCodeMessage"
          [class.success]="joinCodeMessage.type === 'success'"
          [class.error]="joinCodeMessage.type === 'error'"
        >
          <ion-icon [name]="joinCodeMessage.type === 'success' ? 'checkmark-circle-outline' : 'alert-circle-outline'"></ion-icon>
          <span>{{ joinCodeMessage.text }}</span>
        </div>

        <div
          class="invite-message"
          *ngIf="inviteMessage"
          [class.success]="inviteMessage.type === 'success'"
          [class.error]="inviteMessage.type === 'error'"
        >
          <ion-icon [name]="inviteMessage.type === 'success' ? 'checkmark-circle-outline' : 'alert-circle-outline'"></ion-icon>
          <span>{{ inviteMessage.text }}</span>
        </div>

        <div class="signout-block">
          <button type="button" class="danger" (click)="signOut()" [disabled]="isSigningOut">
            <ion-icon name="log-out-outline" *ngIf="!isSigningOut"></ion-icon>
            <ion-spinner *ngIf="isSigningOut" name="crescent"></ion-spinner>
            <span>{{ isSigningOut ? 'מתנתק...' : 'יציאה מהחשבון' }}</span>
          </button>
          <p class="signout-error" *ngIf="signOutError">{{ signOutError }}</p>
        </div>
      </section>
    </div>
  </ng-container>

  <ng-template #loadingState>
    <div class="loading-state">
      <ion-spinner name="crescent"></ion-spinner>
    </div>
  </ng-template>
</ion-content>
