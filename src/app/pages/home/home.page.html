<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button
        fill="clear"
        size="small"
        class="notification-button"
        (click)="openNotifications($event)">
        <ion-icon slot="icon-only" name="notifications-outline"></ion-icon>
        @if (notifications.length > 0) {
          <ion-badge class="notification-badge" color="danger">
            {{ notifications.length }}
          </ion-badge>
        }
      </ion-button>
    </ion-buttons>
    <ion-title>{{ 'home.title' | t }}</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" size="small" (click)="goToProfile()">
        <ion-icon slot="icon-only" name="person-circle-outline"></ion-icon>
      </ion-button>
      <!-- <ion-button fill="clear" size="small" (click)="manualRefresh()">
        <ion-icon slot="icon-only" name="refresh"></ion-icon>
      </ion-button> -->
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-popover
  [isOpen]="isNotificationsOpen"
  [event]="notificationsEvent"
  side="bottom"
  alignment="start"
  cssClass="notifications-popover-shell"
  showBackdrop="false"
  (didDismiss)="onNotificationsDismiss()">
  <ng-template>
    <div class="notifications-popover">
      <div class="notifications-card">
        @if (notifications.length > 0) {
          <ion-list class="notifications-list" lines="none">
            <ion-item *ngFor="let notification of notifications">
              <ion-icon slot="start" color="warning" name="notifications"></ion-icon>
              <ion-label>
                <strong>{{ notification.title }}</strong>
                <p>{{ notification.body }}</p>
                <small class="muted">{{ formatNotificationTime(notification.createdAt) }}</small>
              </ion-label>
            </ion-item>
          </ion-list>
        } @else {
          <div class="empty-card">
            <ion-icon name="notifications-off-outline"></ion-icon>
            <p>{{ 'home.notifications.empty' | t }}</p>
          </div>
        }
      </div>
    </div>
  </ng-template>
</ion-popover>

<ion-content [fullscreen]="true" class="home-content">
  <ion-refresher slot="fixed" pullMin="60" pullMax="120" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content [pullingText]="'home.refresher.pull' | t" refreshingSpinner="crescent"></ion-refresher-content>
  </ion-refresher>

  <div class="bg-shapes">
    <span class="blob blob-1"></span>
    <span class="blob blob-2"></span>
    <span class="blob blob-3"></span>
  </div>

  <div class="screen-wrapper">
    @if (isLoading) {
      <div class="state-block">
        <ion-spinner name="crescent"></ion-spinner>
        <p>{{ 'home.loading' | t }}</p>
      </div>
    } @else if (dailyOverview; as overview) {
      <section class="home-hero">
        <div class="hero-top">
          <div class="device-chip">
            <div class="avatar">
              <ion-icon name="sparkles-outline"></ion-icon>
            </div>
            <div>
              <p class="eyebrow">{{ 'home.custodyNow' | t }}</p>
              <strong>{{ overview.custodyToday.currentParentName || ('home.custodyUnknown' | t) }}</strong>
              @if (overview.custodyToday.nextTransition; as transition) {
                <span>{{ 'home.untilDate' | t:{ date: formatDate(transition.date) } }}</span>
              }
            </div>
          </div>

          @if (overview.summary.hasUrgentTasks) {
            <ion-chip color="danger">
              <ion-icon name="flame-outline"></ion-icon>
              {{ 'home.urgentTask' | t }}
            </ion-chip>
          }
        </div>

        <div class="hero-main">
          <p class="eyebrow">{{ 'home.totalApprovedExpenses' | t }}</p>
          <h1 class="hero-number">{{ formatCurrency(overview.summary.approvedExpensesAmount || 0) }}</h1>
          <p class="muted">
            {{ overview.summary.eventsCount || 0 }} {{ 'home.summary.events' | t }} •
            {{ overview.summary.tasksCount || 0 }} {{ 'home.summary.tasks' | t }}
          </p>
        </div>

        <div class="hero-controls">
          <button
            *ngFor="let action of quickActions | slice:0:3"
            type="button"
            class="hero-control"
            [class.disabled]="action.disabled"
            [attr.aria-disabled]="action.disabled"
            (click)="executeQuickAction(action)"
            [style.--accent]="action.color ? 'var(--ion-color-' + action.color + ')' : 'var(--ion-color-primary)'">
            <ion-icon [name]="action.icon"></ion-icon>
            <span>{{ action.title }}</span>
            @if (action.badge !== undefined && action.badge > 0) {
              <ion-badge color="danger" class="hero-badge">{{ action.badge }}</ion-badge>
            } @else if (action.emptyLabel) {
              <small class="hero-empty">{{ action.emptyLabel }}</small>
            }
          </button>
        </div>

        <!-- <div class="support-card compact elevated">
          <div class="support-heading">
            <p class="eyebrow light">{{ 'home.support.title' | t }}</p>
            <p class="support-copy">{{ 'home.support.subtitle' | t }}</p>
          </div>
          <div class="support-actions switcher">
            <ion-button
              fill="clear"
              class="support-action support-action-whatsapp"
              size="small"
              (click)="openSupportWhatsApp()">
              <ion-icon slot="start" name="logo-whatsapp"></ion-icon>
              {{ 'home.support.whatsapp' | t }}
            </ion-button>
            <ion-button
              fill="clear"
              class="support-action support-action-mail"
              size="small"
              (click)="openSupportMail()">
              <ion-icon slot="start" name="mail-outline"></ion-icon>
              {{ 'home.support.email' | t }}
            </ion-button>
          </div>
        </div> -->
      </section>

      <section class="hero-events-card">
        <div class="card-header">
          <div>
            <p class="eyebrow dark">{{ 'home.todayBoard' | t }}</p>
            <h2>{{ 'home.eventsTitle' | t }}</h2>
          </div>
          <ion-badge color="primary">{{ overview.events.length }}</ion-badge>
        </div>

        @if (overview.events.length > 0) {
          <ion-list class="events-list" lines="none">
            <ion-item
              button
              detail="false"
              class="event-card-item"
              *ngFor="let event of overview.events"
              (click)="navigateToEvent(event.id)">
              <ion-icon slot="start" name="time-outline" class="event-icon"></ion-icon>
              <ion-label>
                <strong>{{ event.title }}</strong>
                <p>
                  {{ formatTime(event.startDate) }}
                  @if (event.location) {
                    <span>• {{ event.location }}</span>
                  }
                  @if (event.childId) {
                    <span class="child-pill">• {{ getChildLabel(event.childId) }}</span>
                  }
                </p>
              </ion-label>
              <ion-icon slot="end" name="chevron-forward-outline" class="chevron"></ion-icon>
            </ion-item>
          </ion-list>
        } @else {
          <div class="empty-card light">
            <ion-icon name="calendar-outline"></ion-icon>
            <p>{{ 'home.noEventsToday' | t }}</p>
          </div>
        }
      </section>

      @if (todayTasks.length > 0) {
        <section class="hero-events-card tasks-card">
          <div class="card-header">
            <div>
              <p class="eyebrow dark">{{ 'home.todayBoard' | t }}</p>
              <h2>{{ 'home.tasksTitle' | t }}</h2>
            </div>
            <ion-badge color="secondary">{{ todayTasks.length }}</ion-badge>
          </div>

          <ion-list class="tasks-list" lines="none">
            <ion-item
              button
              detail="false"
              class="event-card-item"
              *ngFor="let task of todayTasks"
              (click)="navigateToTask(task.id)">
              <ion-icon slot="start" name="checkbox-outline" class="event-icon secondary"></ion-icon>
              <ion-label>
                <strong>{{ task.title }}</strong>
                <p>
                  {{ formatTime(task.dueDate) }}
                  @if (task.priority) {
                    <span>• {{ getPriorityLabel(task.priority) }}</span>
                  }
                </p>
              </ion-label>
              <ion-icon slot="end" name="chevron-forward-outline" class="chevron"></ion-icon>
            </ion-item>
          </ion-list>
        </section>
      }

      <ion-accordion-group
        multiple="true"
        expand="inset"
        class="panel-accordion"
        [value]="openAccordions"
        (ionChange)="openAccordions = $event.detail.value">
      </ion-accordion-group>
    } @else {
      <div class="state-block error">
        <ion-icon name="alert-circle-outline"></ion-icon>
        <h3>{{ 'home.errorLoading' | t }}</h3>
        <ion-button (click)="loadData()">{{ 'home.retry' | t }}</ion-button>
      </div>
    }
  </div>
</ion-content>
