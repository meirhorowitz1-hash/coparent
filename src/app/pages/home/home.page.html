<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>מרכז הבית</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" size="small" (click)="manualRefresh()">
        <ion-icon slot="icon-only" name="refresh"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <ion-refresher slot="fixed" pullMin="60" pullMax="120" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content pullingText="משוך לרענון" refreshingSpinner="crescent"></ion-refresher-content>
  </ion-refresher>

  <div class="screen-wrapper">
    <div *ngIf="isLoading" class="state-block">
      <ion-spinner name="crescent"></ion-spinner>
      <p>טוען...</p>
    </div>

    <ng-container *ngIf="!isLoading && dailyOverview as overview; else overviewError">
      <section class="home-hero surface-card">
        <div class="hero-heading">
          <div>
            <p class="eyebrow">היום</p>
            <h1>{{ formatDate(currentDate) }}</h1>
          </div>
          <ion-chip color="danger" *ngIf="overview.summary.hasUrgentTasks">
            <ion-icon name="flame-outline"></ion-icon>
            משימה דחופה
          </ion-chip>
        </div>

        <div class="hero-metrics">
          <div class="metric">
            <span>אירועים</span>
            <strong>{{ overview.summary.eventsCount || 0 }}</strong>
          </div>
          <div class="metric">
            <span>משימות</span>
            <strong>{{ overview.summary.tasksCount || 0 }}</strong>
          </div>
          <div class="metric">
            <span>הוצאות</span>
            <strong>{{ overview.summary.pendingExpensesCount || overview.pendingExpenses.length || 0 }}</strong>
          </div>
        </div>

        <div class="hero-foot">
          <span>סה״כ הוצאות בהמתנה</span>
          <strong>{{ formatCurrency(overview.summary.totalPendingAmount || 0) }}</strong>
        </div>
      </section>

      <ion-card class="status-card" *ngIf="overview.custodyToday">
        <ion-card-header>
          <ion-card-title>משמורת היום</ion-card-title>
          <ion-card-subtitle>מי נמצא עם הילדים והעברה הבאה</ion-card-subtitle>
        </ion-card-header>
        <ion-card-content>
          <div class="custody-row">
            <div class="pill-icon">
              <ion-icon name="person-circle-outline"></ion-icon>
            </div>
            <div>
              <p class="label">כעת</p>
              <strong>{{ overview.custodyToday.currentParentName || 'לא מוגדר' }}</strong>
              <span>משמורת עד מחר</span>
            </div>
          </div>

          <div class="custody-row next" *ngIf="overview.custodyToday.nextTransition as transition">
            <div class="pill-icon neutral">
              <ion-icon name="swap-horizontal-outline"></ion-icon>
            </div>
            <div>
              <p class="label">העברה הבאה</p>
              <strong>{{ transition.toParentName }}</strong>
              <span>{{ formatDate(transition.date) }}</span>
            </div>
          </div>
        </ion-card-content>
      </ion-card>

      <section class="panel quick-actions-section" *ngIf="quickActions.length">
        <div class="section-heading">
          <div>
            <p class="eyebrow">פעולות</p>
            <h2>מה תרצו לעשות?</h2>
          </div>
          <ion-badge color="primary">{{ quickActions.length }}</ion-badge>
        </div>

        <div class="quick-actions-grid">
          <button
            *ngFor="let action of quickActions"
            type="button"
            class="quick-action-card"
            (click)="executeQuickAction(action)"
            [style.--action-color]="action.color ? 'var(--ion-color-' + action.color + ')' : 'var(--ion-color-primary)'">
            <div class="action-badge" *ngIf="action.badge && action.badge > 0">
              {{ action.badge }}
            </div>
            <div class="icon-ring">
              <ion-icon [name]="action.icon"></ion-icon>
            </div>
            <p>{{ action.title }}</p>
          </button>
        </div>
      </section>

      <section class="panel requests-section">
        <div class="section-heading">
          <div>
            <p class="eyebrow">בקשות</p>
            <h2>בקשות החלפה</h2>
          </div>
          <div class="section-actions">
            <ion-chip color="warning">{{ pendingSwapRequests.length }}</ion-chip>
            <ion-button fill="clear" size="small" [routerLink]="['/tabs/swap-history']">
              היסטוריה
              <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
            </ion-button>
            <ion-button fill="clear" size="small" (click)="toggleSwapRequests()">
              {{ swapRequestsCollapsed ? 'הצג' : 'הסתר' }}
              <ion-icon
                slot="end"
                [name]="swapRequestsCollapsed ? 'chevron-down-outline' : 'chevron-up-outline'">
              </ion-icon>
            </ion-button>
          </div>
        </div>

        <div class="panel-body" *ngIf="!swapRequestsCollapsed">
          <ng-container *ngIf="pendingSwapRequests.length > 0; else emptyPendingRequests">
            <article class="swap-card" *ngFor="let request of pendingSwapRequests">
              <header>
                <div class="parties">
                  <strong>{{ request.requestedByName }}</strong>
                  <ion-icon name="swap-horizontal"></ion-icon>
                  <strong>{{ request.requestedToName }}</strong>
                </div>
                <ion-badge [color]="getRequestStatusColor(request.status)">
                  {{ getRequestStatusLabel(request.status) }}
                </ion-badge>
              </header>

              <div class="swap-timeline">
                <div>
                  <span class="label">תאריך מקורי</span>
                  <strong>{{ formatDate(request.originalDate) }}</strong>
                </div>
                <ion-icon name="chevron-back-outline"></ion-icon>
                <div>
                  <span class="label">תאריך מוצע</span>
                  <strong>{{ formatDate(request.proposedDate) }}</strong>
                </div>
              </div>

              <p class="request-reason" *ngIf="request.reason">{{ request.reason }}</p>

              <ion-note class="request-meta">
                נשלחה ב־{{ formatDate(request.createdAt) }}
              </ion-note>

              <ion-note class="request-meta" *ngIf="request.respondedAt">
                עודכנה ב־{{ formatDate(request.respondedAt) }}
              </ion-note>

              <div class="response-note" *ngIf="request.status !== SwapRequestStatus.PENDING && request.responseNote">
                <ion-icon name="chatbubbles-outline"></ion-icon>
                <span>{{ request.responseNote }}</span>
              </div>

              <ion-textarea
                *ngIf="canRespondToRequest(request)"
                class="request-note-input"
                placeholder="הוסיפו הערה לבן/בת הזוג"
                autoGrow="true"
                [rows]="2"
                [maxlength]="300"
                [name]="'note-' + request.id"
                [(ngModel)]="requestNotes[request.id]">
              </ion-textarea>

              <div class="request-actions" *ngIf="canRespondToRequest(request)">
                <ion-button
                  color="success"
                  expand="block"
                  (click)="handleRequestAction(request, SwapRequestStatus.APPROVED)">
                  <ion-icon slot="start" name="checkmark-circle"></ion-icon>
                  אישור
                </ion-button>
                <ion-button
                  color="danger"
                  expand="block"
                  fill="outline"
                  (click)="handleRequestAction(request, SwapRequestStatus.REJECTED)">
                  <ion-icon slot="start" name="close-circle"></ion-icon>
                  דחייה
                </ion-button>
              </div>

              <ion-button
                *ngIf="canCancelRequest(request)"
                expand="block"
                fill="outline"
                color="medium"
                class="request-cancel-button"
                (click)="handleRequestAction(request, SwapRequestStatus.CANCELLED)">
                <ion-icon slot="start" name="close-circle-outline"></ion-icon>
                בטל בקשה
              </ion-button>
            </article>
          </ng-container>

          <ng-template #emptyPendingRequests>
            <div class="empty-card">
              <ion-icon name="swap-horizontal-outline"></ion-icon>
              <p>אין בקשות ממתינות כרגע</p>
            </div>
          </ng-template>
        </div>
      </section>

      <section class="panel stack-section">
        <div class="section-heading">
          <div>
            <p class="eyebrow">לוח היום</p>
            <h2>אירועים</h2>
          </div>
          <ion-chip color="primary">{{ overview.events.length }}</ion-chip>
        </div>

        <ng-container *ngIf="overview.events.length > 0; else noEvents">
          <div class="stack-list">
            <button
              type="button"
              class="stack-item"
              *ngFor="let event of overview.events"
              (click)="navigateToEvent(event.id)">
              <div class="stack-icon accent">
                <ion-icon name="time-outline"></ion-icon>
              </div>
              <div class="stack-body">
                <strong>{{ event.title }}</strong>
                <p>
                  {{ formatTime(event.startDate) }}
                  <ng-container *ngIf="event.location">
                    • {{ event.location }}
                  </ng-container>
                </p>
              </div>
              <ion-icon class="chevron" name="chevron-forward-outline"></ion-icon>
            </button>
          </div>
        </ng-container>

        <ng-template #noEvents>
          <div class="empty-card">
            <ion-icon name="calendar-outline"></ion-icon>
            <p>אין אירועים מתוכננים להיום</p>
          </div>
        </ng-template>
      </section>

      <section class="panel stack-section">
        <div class="section-heading">
          <div>
            <p class="eyebrow">תכנון</p>
            <h2>משימות קרובות</h2>
          </div>
          <ion-chip [color]="overview.summary.hasUrgentTasks ? 'danger' : 'warning'">
            {{ overview.summary.tasksCount || 0 }}
          </ion-chip>
        </div>

        <ng-container *ngIf="overview.upcomingTasks.length > 0; else noTasks">
          <div class="stack-list">
            <button
              type="button"
              class="stack-item"
              *ngFor="let task of overview.upcomingTasks.slice(0, 5)"
              (click)="navigateToTask(task.id)">
              <ion-checkbox
                [checked]="task.status === 'completed'"
                (click)="$event.stopPropagation()"
                (ionChange)="$event.stopPropagation()">
              </ion-checkbox>
              <div class="stack-body">
                <strong>{{ task.title }}</strong>
                <p>
                  <ion-icon [name]="getCategoryIcon(task.category || 'other')" size="small"></ion-icon>
                  {{ formatDate(task.dueDate) }}
                </p>
              </div>
              <ion-badge [color]="getTaskPriorityColor(task.priority)">
                {{ task.priority }}
              </ion-badge>
              <ion-icon class="chevron" name="chevron-forward-outline"></ion-icon>
            </button>
          </div>

          <ion-button
            expand="block"
            fill="clear"
            *ngIf="overview.upcomingTasks.length > 5"
            (click)="executeQuickAction({ id: 'tasks', title: '', icon: '', route: '/tasks' })">
            הצג עוד משימות
            <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
          </ion-button>
        </ng-container>

        <ng-template #noTasks>
          <div class="empty-card">
            <ion-icon name="checkbox-outline"></ion-icon>
            <p>אין משימות קרובות</p>
          </div>
        </ng-template>
      </section>

      <section class="panel stack-section">
        <div class="section-heading">
          <div>
            <p class="eyebrow">כספים</p>
            <h2>הוצאות ממתינות</h2>
          </div>
          <ion-chip color="success">{{ overview.pendingExpenses.length }}</ion-chip>
        </div>

        <ng-container *ngIf="overview.pendingExpenses.length > 0; else noExpenses">
          <div class="stack-list">
            <button
              type="button"
              class="stack-item"
              *ngFor="let expense of overview.pendingExpenses.slice(0, 3)"
              (click)="navigateToExpense(expense.id)">
              <div class="stack-icon positive">
                <ion-icon [name]="getCategoryIcon(expense.category)"></ion-icon>
              </div>
              <div class="stack-body">
                <strong>{{ expense.title }}</strong>
                <p>{{ formatDate(expense.date) }}</p>
              </div>
              <div class="amount">
                <strong>{{ formatCurrency(expense.amount) }}</strong>
                <ion-badge color="warning">ממתין</ion-badge>
              </div>
              <ion-icon class="chevron" name="chevron-forward-outline"></ion-icon>
            </button>
          </div>

          <ion-button
            expand="block"
            fill="clear"
            *ngIf="overview.pendingExpenses.length > 3"
            (click)="executeQuickAction({ id: 'expenses', title: '', icon: '', route: '/expenses' })">
            הצג עוד הוצאות
            <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
          </ion-button>
        </ng-container>

        <ng-template #noExpenses>
          <div class="empty-card">
            <ion-icon name="wallet-outline"></ion-icon>
            <p>אין הוצאות ממתינות</p>
          </div>
        </ng-template>
      </section>
    </ng-container>
  </div>
</ion-content>

<ng-template #overviewError>
  <div class="state-block error">
    <ion-icon name="alert-circle-outline"></ion-icon>
    <h3>שגיאה בטעינת הנתונים</h3>
    <ion-button (click)="loadData()">נסה שוב</ion-button>
  </div>
</ng-template>
