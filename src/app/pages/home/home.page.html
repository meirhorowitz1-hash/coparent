<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>מרכז הבית</ion-title>
    <ion-buttons slot="end">
      <ion-button fill="clear" size="small" (click)="manualRefresh()">
        <ion-icon slot="icon-only" name="refresh"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true" class="home-content">
  <ion-refresher slot="fixed" pullMin="60" pullMax="120" (ionRefresh)="handleRefresh($event)">
    <ion-refresher-content pullingText="משוך לרענון" refreshingSpinner="crescent"></ion-refresher-content>
  </ion-refresher>

  <div class="bg-shapes">
    <span class="blob blob-1"></span>
    <span class="blob blob-2"></span>
    <span class="blob blob-3"></span>
  </div>

  <div class="screen-wrapper">
    @if (isLoading) {
      <div class="state-block">
        <ion-spinner name="crescent"></ion-spinner>
        <p>טוען...</p>
      </div>
    } @else if (dailyOverview; as overview) {
      <section class="home-hero">
        <div class="hero-top">
          <div class="device-chip">
            <div class="avatar">
              <ion-icon name="sparkles-outline"></ion-icon>
            </div>
            <div>
              <p class="eyebrow">משמורת עכשיו</p>
              <strong>{{ overview.custodyToday.currentParentName || 'לא מוגדר' }}</strong>
              @if (overview.custodyToday.nextTransition; as transition) {
                <span>עד {{ formatDate(transition.date) }}</span>
              }
            </div>
          </div>

          @if (overview.summary.hasUrgentTasks) {
            <ion-chip color="danger">
              <ion-icon name="flame-outline"></ion-icon>
              משימה דחופה
            </ion-chip>
          }
        </div>

        <div class="hero-main">
          <p class="eyebrow">סה״כ הוצאות בהמתנה</p>
          <h1 class="hero-number">{{ formatCurrency(overview.summary.totalPendingAmount || 0) }}</h1>
          <p class="muted">
            {{ overview.summary.eventsCount || 0 }} אירועים • {{ overview.summary.tasksCount || 0 }} משימות
          </p>
          @if (overview.pendingExpenses.length > 0) {
            <div class="hero-highlight">
              <div class="pill warning">הוצאות ממתינות</div>
              <div class="highlight-metrics">
                <strong>{{ overview.pendingExpenses.length }}</strong>
                <span>{{ formatCurrency(overview.summary.totalPendingAmount || 0) }}</span>
              </div>
            </div>
          }
        </div>

        <div class="hero-controls">
          <button
            type="button"
            class="hero-control"
            [style.--accent]="'var(--ion-color-primary)'"
            (click)="executeQuickAction({ id: 'add-event', title: 'אירוע חדש', icon: 'add-circle-outline', route: '/calendar' })">
            <ion-icon name="add-circle-outline"></ion-icon>
            <span>אירוע חדש</span>
          </button>
          <button
            *ngFor="let action of quickActions | slice:0:3"
            type="button"
            class="hero-control"
            (click)="executeQuickAction(action)"
            [style.--accent]="action.color ? 'var(--ion-color-' + action.color + ')' : 'var(--ion-color-primary)'">
            <ion-icon [name]="action.icon"></ion-icon>
            <span>{{ action.title }}</span>
          </button>
        </div>
      </section>

      <ion-accordion-group
        multiple="true"
        expand="inset"
        class="panel-accordion"
        [value]="openAccordions"
        (ionChange)="openAccordions = $event.detail.value">
        <ion-accordion value="requests" class="accordion-card">
          <div slot="header" class="accordion-header">
            <div>
              <p class="eyebrow">בקשות</p>
              <h2>בקשות החלפה</h2>
            </div>
            <div class="accordion-meta">
              <ion-chip class="accordion-chip" color="warning">{{ pendingSwapRequests.length }}</ion-chip>
              <ion-icon class="accordion-chevron" name="chevron-down-outline"></ion-icon>
            </div>
          </div>
          <div slot="content" class="accordion-body">
            @if (pendingSwapRequests.length > 0) {
              <article class="swap-card" *ngFor="let request of pendingSwapRequests">
                <header>
                  <div class="parties">
                    <strong>{{ request.requestedByName }}</strong>
                    <ion-icon name="swap-horizontal"></ion-icon>
                    <strong>{{ request.requestedToName }}</strong>
                  </div>
                  <div class="header-actions">
                    <ion-chip color="tertiary" class="type-chip">
                      {{ getRequestTypeLabel(request) }}
                    </ion-chip>
                    <ion-badge [color]="getRequestStatusColor(request.status)">
                      {{ getRequestStatusLabel(request.status) }}
                    </ion-badge>
                  </div>
                </header>

                <div class="swap-timeline">
                  <div>
                    <span class="label">תאריך מקורי</span>
                    <strong>{{ formatDate(request.originalDate) }}</strong>
                  </div>
                  @if (request.proposedDate) {
                    <ion-icon name="chevron-back-outline"></ion-icon>
                    <div>
                      <span class="label">תאריך מוצע</span>
                      <strong>{{ formatDate(request.proposedDate) }}</strong>
                    </div>
                  } @else {
                    <div class="oneway-note">
                      <ion-icon name="arrow-forward-circle"></ion-icon>
                      <span>בקשה ללא תאריך חלופי</span>
                    </div>
                  }
                </div>

                @if (request.reason) {
                  <p class="request-reason">{{ request.reason }}</p>
                }

                <ion-note class="request-meta">
                  נשלחה ב־{{ formatDate(request.createdAt) }}
                </ion-note>

                @if (request.respondedAt) {
                  <ion-note class="request-meta">
                    עודכנה ב־{{ formatDate(request.respondedAt) }}
                  </ion-note>
                }

                @if (request.status !== SwapRequestStatus.PENDING && request.responseNote) {
                  <div class="response-note">
                    <ion-icon name="chatbubbles-outline"></ion-icon>
                    <span>{{ request.responseNote }}</span>
                  </div>
                }

                @if (canRespondToRequest(request)) {
                  <ion-textarea
                    class="request-note-input"
                    placeholder="הוסיפו הערה לבן/בת הזוג"
                    autoGrow="true"
                    [rows]="2"
                    [maxlength]="300"
                    [name]="'note-' + request.id"
                    [(ngModel)]="requestNotes[request.id]">
                  </ion-textarea>

                  <div class="request-actions">
                    <ion-button
                      color="success"
                      expand="block"
                      (click)="handleRequestAction(request, SwapRequestStatus.APPROVED)">
                      <ion-icon slot="start" name="checkmark-circle"></ion-icon>
                      אישור
                    </ion-button>
                    <ion-button
                      color="danger"
                      expand="block"
                      fill="outline"
                      (click)="handleRequestAction(request, SwapRequestStatus.REJECTED)">
                      <ion-icon slot="start" name="close-circle"></ion-icon>
                      דחייה
                    </ion-button>
                  </div>
                }

                @if (canCancelRequest(request)) {
                  <ion-button
                    expand="block"
                    fill="outline"
                    color="medium"
                    class="request-cancel-button"
                    (click)="handleRequestAction(request, SwapRequestStatus.CANCELLED)">
                    <ion-icon slot="start" name="close-circle-outline"></ion-icon>
                    בטל בקשה
                  </ion-button>
                }
              </article>
            } @else {
              <div class="empty-card">
                <ion-icon name="swap-horizontal-outline"></ion-icon>
                <p>אין בקשות ממתינות כרגע</p>
              </div>
            }
           
          </div>
        </ion-accordion>

        <ion-accordion value="events" class="accordion-card">
          <div slot="header" class="accordion-header">
            <div>
              <p class="eyebrow">לוח היום</p>
              <h2>אירועים</h2>
            </div>
            <div class="accordion-meta">
              <ion-chip class="accordion-chip" color="primary">{{ overview.events.length }}</ion-chip>
              <ion-icon class="accordion-chevron" name="chevron-down-outline"></ion-icon>
            </div>
          </div>
          <div slot="content" class="accordion-body">
            @if (overview.events.length > 0) {
              <ion-list class="stack-list" lines="none">
                <ion-item
                  button
                  detail="false"
                  class="stack-item"
                  *ngFor="let event of overview.events"
                  (click)="navigateToEvent(event.id)">
                  <div slot="start" class="stack-icon accent">
                    <ion-icon name="time-outline"></ion-icon>
                  </div>
                  <ion-label class="stack-body">
                    <strong>{{ event.title }}</strong>
                    <p>
                      {{ formatTime(event.startDate) }}
                      @if (event.location) {
                        <span>• {{ event.location }}</span>
                      }
                    </p>
                  </ion-label>
                  <ion-icon slot="end" class="chevron" name="chevron-forward-outline"></ion-icon>
                </ion-item>
              </ion-list>
            } @else {
              <div class="empty-card">
                <ion-icon name="calendar-outline"></ion-icon>
                <p>אין אירועים מתוכננים להיום</p>
              </div>
            }
          </div>
        </ion-accordion>

        <ion-accordion value="tasks" class="accordion-card">
          <div slot="header" class="accordion-header">
            <div>
              <p class="eyebrow">תכנון</p>
              <h2>משימות קרובות</h2>
            </div>
            <div class="accordion-meta">
              <ion-chip class="accordion-chip" color="medium">
                {{ overview.upcomingTasks.length }}
              </ion-chip>
              <ion-icon class="accordion-chevron" name="chevron-down-outline"></ion-icon>
            </div>
          </div>
          <div slot="content" class="accordion-body">
            @if (overview.upcomingTasks.length > 0) {
              <ion-list class="stack-list" lines="none">
                <ion-item
                  button
                  detail="false"
                  class="stack-item compact"
                  *ngFor="let task of overview.upcomingTasks.slice(0, 5)"
                  (click)="navigateToTask(task.id)">
                  <ion-checkbox
                    slot="start"
                    [checked]="task.status === TaskStatus.COMPLETED"
                    (click)="$event.stopPropagation()"
                    (ionChange)="completeTask(task, $event.detail.checked); $event.stopPropagation()">
                  </ion-checkbox>
                  <ion-label class="stack-body">
                    <strong>{{ task.title }}</strong>
                    <p class="muted">{{ formatDate(task.dueDate) }}</p>
                  </ion-label>
                  <ion-chip slot="end" [color]="getTaskPriorityColor(task.priority)" outline>
                    {{ getPriorityLabel(task.priority) }}
                  </ion-chip>
                </ion-item>
              </ion-list>

              @if (overview.upcomingTasks.length > 5) {
                <ion-button
                  expand="block"
                  fill="clear"
                  (click)="executeQuickAction({ id: 'tasks', title: '', icon: '', route: '/tasks' })">
                  הצג עוד משימות
                  <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
                </ion-button>
              }
            } @else {
              <div class="empty-card">
                <ion-icon name="checkbox-outline"></ion-icon>
                <p>אין משימות קרובות</p>
              </div>
            }
          </div>
        </ion-accordion>

        <ion-accordion value="expenses" class="accordion-card">
          <div slot="header" class="accordion-header">
            <div>
              <p class="eyebrow">כספים</p>
              <h2>הוצאות ממתינות</h2>
            </div>
            <div class="accordion-meta">
              <ion-chip class="accordion-chip" color="success">{{ overview.pendingExpenses.length }}</ion-chip>
              <ion-icon class="accordion-chevron" name="chevron-down-outline"></ion-icon>
            </div>
          </div>
          <div slot="content" class="accordion-body">
            @if (overview.pendingExpenses.length > 0) {
              <ion-list class="stack-list" lines="none">
                <ion-item
                  detail="false"
                  class="stack-item"
                  *ngFor="let expense of overview.pendingExpenses.slice(0, 3)"
                  (click)="navigateToExpense(expense.id, true)">
                  <div slot="start" class="stack-icon positive">
                    <ion-icon [name]="getCategoryIcon(expense.category)"></ion-icon>
                  </div>
                  <div class="stack-body">
                    <div class="stack-main">
                      <strong>{{ expense.title }}</strong>
                      <p>{{ formatDate(expense.date) }}</p>
                    </div>
                    <div class="stack-meta">
                      <div class="amount">
                        <strong>{{ formatCurrency(expense.amount) }}</strong>
                        <ion-badge color="warning">ממתין</ion-badge>
                      </div>
                      @if (canApproveExpense(expense)) {
                        <div class="stack-actions" (click)="$event.stopPropagation()">
                          <ion-button
                            size="small"
                            fill="clear"
                            color="success"
                            (click)="handleExpenseApproval(expense.id, true, $event)">
                            אשר
                          </ion-button>
                          <ion-button
                            size="small"
                            fill="clear"
                            color="medium"
                            (click)="handleExpenseApproval(expense.id, false, $event)">
                            דחה
                          </ion-button>
                        </div>
                      }
                    </div>
                  </div>
                </ion-item>
              </ion-list>

              @if (overview.pendingExpenses.length > 3) {
                <ion-button
                  expand="block"
                  fill="clear"
                  (click)="executeQuickAction({ id: 'expenses', title: '', icon: '', route: '/expenses' })">
                  הצג עוד הוצאות
                  <ion-icon slot="end" name="chevron-forward-outline"></ion-icon>
                </ion-button>
              }
            } @else {
              <div class="empty-card">
                <ion-icon name="wallet-outline"></ion-icon>
                <p>אין הוצאות ממתינות</p>
              </div>
            }
          </div>
        </ion-accordion>
      </ion-accordion-group>
    } @else {
      <div class="state-block error">
        <ion-icon name="alert-circle-outline"></ion-icon>
        <h3>שגיאה בטעינת הנתונים</h3>
        <ion-button (click)="loadData()">נסה שוב</ion-button>
      </div>
    }
  </div>
</ion-content>
