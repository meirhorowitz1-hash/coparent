<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-title>היסטוריה</ion-title>
    <ion-buttons slot="end">
      <ion-button [routerLink]="['/tabs/home']" fill="clear">
        <ion-icon slot="icon-only" name="close"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="history-shell">
    <section class="filters-card">
      <div>
        <p class="eyebrow">סינון לפי חודש</p>
        <h2>{{ selectedMonthLabel }}</h2>
        <p class="hint">היסטוריה של הוצאות, משימות ובקשות החלפה</p>
      </div>
      <div class="filter-actions">
        <ion-select
          interface="alert"
          [(ngModel)]="selectedMonth"
          name="selectedMonth"
          placeholder="בחרו חודש"
          (ionChange)="onMonthChange($event.detail.value)">
          <ion-select-option
            *ngFor="let month of monthOptions"
            [value]="month.value">
            {{ month.label }}
          </ion-select-option>
        </ion-select>
        <ion-button
          *ngIf="selectedMonth !== 'all'"
          fill="clear"
          size="small"
          color="medium"
          (click)="clearMonthFilter()">
          <ion-icon slot="start" name="close-circle-outline"></ion-icon>
          נקה
        </ion-button>
      </div>
    </section>

    @if (!isLoading) {
      <ion-accordion-group multiple="true" class="history-accordion">
        @if (showExpenses()) {
        <div class="accordion-shell">
          <ion-accordion value="expenses" class="history-accordion-card">
            <div slot="header" class="accordion-header">
              <div>
                <p class="eyebrow">כספים</p>
                <h3>הוצאות</h3>
              </div>
              <ion-chip color="primary">
                <ion-icon name="wallet-outline"></ion-icon>
                <ion-label>{{ filteredExpenses.length }}</ion-label>
              </ion-chip>
            </div>
            <div slot="content" class="accordion-body">
              @if (filteredExpenses.length) {
                <ion-list class="history-list" lines="none">
                  <ion-item *ngFor="let expense of filteredExpenses" class="history-item" detail="false">
                    <ion-icon slot="start" name="receipt-outline"></ion-icon>
                    <ion-label>
                      <div class="item-row">
                        <strong>{{ expense.title }}</strong>
                        <span class="date">{{ formatDate(expense.date) }}</span>
                      </div>
                      @if (expense.notes) {
                        <p class="note">{{ expense.notes }}</p>
                      }
                      @if (expense.id.startsWith('fixed-')) {
                        <p class="meta">הוצאה קבועה</p>
                      }
                      <p class="meta">
                        נוצרה ב־{{ formatDate(expense.createdAt) }}
                        • על ידי {{ expense.createdByName || expense.createdBy || 'לא ידוע' }}
                      </p>
                    </ion-label>
                    <div class="amount-pill">{{ formatCurrency(expense.amount) }}</div>
                    <ion-badge
                      slot="end"
                      [color]="expense.status === 'approved' ? 'success' : expense.status === 'pending' ? 'warning' : 'medium'">
                      {{ expense.status === 'approved' ? 'אושרה' : expense.status === 'pending' ? 'ממתינה' : 'נדחתה' }}
                    </ion-badge>
                  </ion-item>
                </ion-list>
              } @else {
                <div class="empty-row">
                  <ion-icon name="trending-down-outline"></ion-icon>
                  <p>אין הוצאות עבור החודש שנבחר</p>
                </div>
              }
            </div>
          </ion-accordion>
        </div>
        }

        @if (showTasks()) {
        <div class="accordion-shell">
          <ion-accordion value="tasks" class="history-accordion-card">
            <div slot="header" class="accordion-header">
              <div>
                <p class="eyebrow">משימות</p>
                <h3>פעילות משותפת</h3>
              </div>
              <ion-chip color="tertiary">
                <ion-icon name="checkbox-outline"></ion-icon>
                <ion-label>{{ filteredTasks.length }}</ion-label>
              </ion-chip>
            </div>
            <div slot="content" class="accordion-body">
              @if (filteredTasks.length) {
                <ion-list class="history-list" lines="none">
                  <ion-item *ngFor="let task of filteredTasks" class="history-item" detail="false">
                    <ion-icon slot="start" name="list-outline"></ion-icon>
                    <ion-label>
                      <div class="item-row">
                        <strong>{{ task.title }}</strong>
                        <span class="date">{{ formatDate(task.dueDate) }}</span>
                      </div>
                      @if (task.description) {
                        <p class="note">{{ task.description }}</p>
                      }
                      <p class="meta">סטטוס: {{ getTaskStatusLabel(task.status) }}</p>
                    </ion-label>
                    <ion-badge
                      slot="end"
                      [color]="getTaskPriorityColor(task.priority)">
                      {{ task.priority === 'urgent' ? 'דחוף' : task.priority === 'high' ? 'גבוהה' : task.priority === 'medium' ? 'בינונית' : 'נמוכה' }}
                    </ion-badge>
                  </ion-item>
                </ion-list>
              } @else {
                <div class="empty-row">
                  <ion-icon name="calendar-outline"></ion-icon>
                  <p>אין משימות לחודש זה</p>
                </div>
              }
            </div>
          </ion-accordion>
        </div>
        }

        @if (showCalendar()) {
        <div class="accordion-shell">
          <ion-accordion value="events" class="history-accordion-card">
            <div slot="header" class="accordion-header">
              <div>
                <p class="eyebrow">לוח שנה</p>
                <h3>אירועים</h3>
              </div>
              <ion-chip color="tertiary">
                <ion-icon name="calendar-outline"></ion-icon>
                <ion-label>{{ filteredEvents.length }}</ion-label>
              </ion-chip>
            </div>
            <div slot="content" class="accordion-body">
              @if (filteredEvents.length) {
                <ion-list class="history-list" lines="none">
                  <ion-item *ngFor="let event of filteredEvents" class="history-item" detail="false">
                    <ion-icon slot="start" name="calendar-outline"></ion-icon>
                    <ion-label>
                      <div class="item-row">
                        <strong>{{ event.title }}</strong>
                        <span class="date">{{ formatDate(event.startDate) }}</span>
                      </div>
                      <p class="meta">
                        {{ formatDate(event.startDate) }}
                        <span *ngIf="!event.isAllDay">• {{ formatTime(event.startDate) }} - {{ formatTime(event.endDate) }}</span>
                      </p>
                      <p class="meta">סוג: {{ getEventTypeLabel(event.type) }}</p>
                    </ion-label>
                  </ion-item>
                </ion-list>
              } @else {
                <div class="empty-row">
                  <ion-icon name="calendar-outline"></ion-icon>
                  <p>אין אירועים עבור החודש</p>
                </div>
              }
            </div>
          </ion-accordion>
        </div>

        <div class="accordion-shell">
          <ion-accordion value="swap" class="history-accordion-card">
            <div slot="header" class="accordion-header">
              <div>
                <p class="eyebrow">לוח שנה</p>
                <h3>בקשות החלפה</h3>
              </div>
              <ion-chip color="success">
                <ion-icon name="swap-horizontal"></ion-icon>
                <ion-label>{{ filteredSwapRequests.length }}</ion-label>
              </ion-chip>
            </div>
            <div slot="content" class="accordion-body">

              @if (filteredSwapRequests.length) {
                <ion-list class="history-list" lines="none">
                  <ion-item *ngFor="let request of filteredSwapRequests" class="history-item" detail="false">
                    <ion-icon slot="start" name="swap-horizontal"></ion-icon>
                    <ion-label>
                      <div class="item-row parties">
                        <strong>{{ request.requestedByName }}</strong>
                        <ion-icon name="chevron-back"></ion-icon>
                        <strong>{{ request.requestedToName }}</strong>
                      </div>
                      <ion-chip size="small" color="tertiary">
                        {{ getRequestTypeLabel(request) }}
                      </ion-chip>
                      <p class="meta">הוגשה ב־{{ formatDate(request.createdAt) }}</p>
                      @if (request.reason) {
                        <p class="note">{{ request.reason }}</p>
                      }
                      <div class="dates-row">
                        <div>
                          <span class="label">תאריך מקורי</span>
                          <strong>{{ formatDate(request.originalDate) }}</strong>
                        </div>
                        @if (request.proposedDate) {
                          <ion-icon name="swap-horizontal-outline"></ion-icon>
                          <div>
                            <span class="label">תאריך מוצע</span>
                            <strong>{{ formatDate(request.proposedDate) }}</strong>
                          </div>
                        } @else {
                          <div class="no-return">
                            <ion-icon name="arrow-forward-circle"></ion-icon>
                            <span>ללא תאריך חלופי</span>
                          </div>
                        }
                      </div>
                    </ion-label>
                    <ion-badge
                      slot="end"
                      [color]="getRequestStatusColor(request.status)">
                      {{ getRequestStatusLabel(request.status) }}
                    </ion-badge>
                  </ion-item>
                </ion-list>
              } @else {
                <div class="empty-row">
                  <ion-icon name="time-outline"></ion-icon>
                  <p>אין בקשות החלפה עבור החודש</p>
                </div>
              }
            </div>
          </ion-accordion>
        </div>
        }
      </ion-accordion-group>
    } @else {
      <div class="empty-row">
        <ion-spinner name="crescent"></ion-spinner>
        <p>טוען היסטוריה...</p>
      </div>
    }
  </div>
</ion-content>
