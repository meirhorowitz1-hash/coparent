<ion-header>
  <ion-toolbar>
    <ion-title>{{ t('custody.title') }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="cancel()">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
  
  <div class="progress-steps">
    <div class="step" [class.active]="step === 'template'" [class.completed]="step !== 'template'">
      <div class="step-circle">1</div>
      <div class="step-label">{{ t('custody.step.template') }}</div>
    </div>
    <div class="step-line" [class.active]="step !== 'template'"></div>
    <div class="step" [class.active]="step === 'customize'" [class.completed]="step === 'confirm'">
      <div class="step-circle">2</div>
      <div class="step-label">{{ t('custody.step.customize') }}</div>
    </div>
    <div class="step-line" [class.active]="step === 'confirm'"></div>
    <div class="step" [class.active]="step === 'confirm'">
      <div class="step-circle">3</div>
      <div class="step-label">{{ t('custody.step.confirm') }}</div>
    </div>
  </div>
</ion-header>

<ion-content class="ion-padding">
  
  <!-- Step 1: Template Selection -->
  <div *ngIf="step === 'template'" class="step-content">
    <h2>{{ t('custody.selectTemplate.title') }}</h2>
    <p class="subtitle">{{ t('custody.selectTemplate.subtitle') }}</p>
    
    <div class="templates-grid">
      <ion-card 
        *ngFor="let template of templates" 
        button="true"
        (click)="selectTemplate(template)"
        [class.selected]="selectedTemplate?.id === template.id">
        <ion-card-header>
          <ion-card-title>{{ getTemplateName(template) }}</ion-card-title>
        </ion-card-header>
        <ion-card-content>
          <p>{{ describeTemplate(template) }}</p>
          <ion-icon 
            *ngIf="selectedTemplate?.id === template.id" 
            name="checkmark-circle" 
            color="primary">
          </ion-icon>
        </ion-card-content>
      </ion-card>
    </div>
  </div>

  <!-- Step 2: Customize Days -->
  <div *ngIf="step === 'customize'" class="step-content">
    <h2>{{ t('custody.customize.title') }}</h2>
    <p class="subtitle">{{ t('custody.customize.subtitle') }}</p>

    <div *ngIf="custodySchedule.pattern === 'biweekly'" class="biweekly-toggle">
      <ion-segment [(ngModel)]="activeBiweeklyWeek" mode="ios">
        <ion-segment-button value="a">
          {{ t('custody.customize.week1') }}
        </ion-segment-button>
        <ion-segment-button value="b">
          {{ t('custody.customize.week2') }}
        </ion-segment-button>
      </ion-segment>
      <ion-note>{{ t('custody.customize.biweeklyNote') }}</ion-note>
    </div>

    <ng-container *ngTemplateOutlet="approvalBanner"></ng-container>
    
    <div class="parent-section">
      <h3 class="parent1-header">
        <ion-icon name="person"></ion-icon>
        {{ parentLabels.parent1 }}
      </h3>
      <div class="days-selector">
        <ion-button 
          *ngFor="let day of weekDays"
          [fill]="isDaySelected('parent1', day.value) ? 'solid' : 'outline'"
          [color]="isDaySelected('parent1', day.value) ? 'success' : 'medium'"
          (click)="toggleDay('parent1', day.value)"
          class="day-button">
          {{ day.short }}
        </ion-button>
      </div>
      <ion-note class="hint-note" *ngIf="custodySchedule.pattern === 'biweekly'">
        {{ t('custody.customize.daysOf', { week: getWeekLabel(), parent: parentLabels.parent1 }) }}
      </ion-note>
    </div>

    <div class="parent-section">
      <h3 class="parent2-header">
        <ion-icon name="person"></ion-icon>
        {{ parentLabels.parent2 }}
      </h3>
      <div class="days-selector">
        <ion-button 
          *ngFor="let day of weekDays"
          [fill]="isDaySelected('parent2', day.value) ? 'solid' : 'outline'"
          [color]="isDaySelected('parent2', day.value) ? 'primary' : 'medium'"
          (click)="toggleDay('parent2', day.value)"
          class="day-button">
          {{ day.short }}
        </ion-button>
      </div>
      <ion-note class="hint-note" *ngIf="custodySchedule.pattern === 'biweekly'">
        {{ t('custody.customize.daysOf', { week: getWeekLabel(), parent: parentLabels.parent2 }) }}
      </ion-note>
    </div>

    <ion-item>
      <ion-label>{{ t('custody.customize.pattern') }}</ion-label>
      <ion-select [(ngModel)]="custodySchedule.pattern" interface="action-sheet" [disabled]="isApprovalPending">
        <ion-select-option value="weekly">{{ t('custody.customize.pattern.weekly') }}</ion-select-option>
        <ion-select-option value="biweekly">{{ t('custody.customize.pattern.biweekly') }}</ion-select-option>
        <ion-select-option value="week_on_week_off">{{ t('custody.customize.pattern.weekOnOff') }}</ion-select-option>
        <ion-select-option value="custom">{{ t('custody.customize.pattern.custom') }}</ion-select-option>
      </ion-select>
    </ion-item>

    <div class="start-date-row">
      <div class="start-date-copy">
        <span>{{ t('custody.customize.startDate') }}</span>
        <strong>{{ custodySchedule.startDate | date:'dd/MM/yyyy' }}</strong>
      </div>
      <ion-datetime-button
        class="date-picker-button"
        fill="clear"
        [disabled]="isApprovalPending"
        datetime="custody-start-date">
      </ion-datetime-button>
    </div>
    <ion-modal keepContentsMounted="true">
      <ng-template>
        <ion-datetime 
          id="custody-start-date"
          [value]="startDateIso"
          (ionChange)="onStartDateChange($event.detail.value || null)"
          presentation="date"
          [disabled]="isApprovalPending">
        </ion-datetime>
      </ng-template>
    </ion-modal>

    <ion-button 
      expand="block" 
      (click)="goToConfirm()"
      [disabled]="isApprovalPending || (custodySchedule.parent1Days.length === 0 && custodySchedule.parent2Days.length === 0)">
      {{ t('custody.customize.continue') }}
      <ion-icon name="arrow-back" slot="end"></ion-icon>
    </ion-button>
  </div>

  <!-- Step 3: Confirm -->
  <div *ngIf="step === 'confirm'" class="step-content">
    <h2>{{ t('custody.confirm.title') }}</h2>
    <p class="subtitle">{{ t('custody.confirm.subtitle') }}</p>

    <ng-container *ngTemplateOutlet="approvalBanner"></ng-container>

    <ion-card>
      <ion-card-header>
        <ion-card-title>{{ t('custody.confirm.summary') }}</ion-card-title>
      </ion-card-header>
      <ion-card-content>
        <div class="summary-item">
          <strong>{{ t('custody.confirm.template') }}</strong>
          <span>{{ getTemplateName(selectedTemplate) || t('custody.confirm.customTemplate') }}</span>
        </div>
        
        <div class="start-date-row compact-row">
          <div class="start-date-copy">
            <span>{{ t('custody.confirm.startDate') }}</span>
            <strong>{{ custodySchedule.startDate | date:'dd/MM/yyyy' }}</strong>
          </div>
          <ion-datetime-button
            class="date-picker-button"
            fill="clear"
            [disabled]="isApprovalPending"
            datetime="custody-start-date-confirm">
          </ion-datetime-button>
        </div>
        <ion-modal keepContentsMounted="true">
          <ng-template>
            <ion-datetime 
              id="custody-start-date-confirm"
              [value]="startDateIso"
              (ionChange)="onStartDateChange($event.detail.value || null)"
              presentation="date"
              [disabled]="isApprovalPending">
            </ion-datetime>
          </ng-template>
        </ion-modal>

        <div class="summary-section">
          <h4 class="parent1-color">{{ parentLabels.parent1 }}</h4>
          <div class="days-display">
            <span *ngFor="let dayValue of custodySchedule.parent1Days" class="day-chip parent1">
              {{ weekDays[dayValue].label }}
            </span>
            <span *ngIf="custodySchedule.parent1Days.length === 0" class="empty-state">
              {{ t('custody.confirm.noDaysSelected') }}
            </span>
          </div>
        </div>

        <div class="summary-section" *ngIf="custodySchedule.pattern === 'biweekly'">
          <h5 class="parent1-color sub-heading">{{ t('custody.customize.week2') }}</h5>
          <div class="days-display">
            <span *ngFor="let dayValue of custodySchedule.biweeklyAltParent1Days" class="day-chip parent1">
              {{ weekDays[dayValue].label }}
            </span>
            <span *ngIf="(custodySchedule.biweeklyAltParent1Days?.length ?? 0) === 0" class="empty-state">
              {{ t('custody.confirm.noDaysSelected') }}
            </span>
          </div>
        </div>

        <div class="summary-section">
          <h4 class="parent2-color">{{ parentLabels.parent2 }}</h4>
          <div class="days-display">
            <span *ngFor="let dayValue of custodySchedule.parent2Days" class="day-chip parent2">
              {{ weekDays[dayValue].label }}
            </span>
            <span *ngIf="custodySchedule.parent2Days.length === 0" class="empty-state">
              {{ t('custody.confirm.noDaysSelected') }}
            </span>
          </div>
        </div>

        <div class="summary-section" *ngIf="custodySchedule.pattern === 'biweekly'">
          <h5 class="parent2-color sub-heading">{{ t('custody.customize.week2') }}</h5>
          <div class="days-display">
            <span *ngFor="let dayValue of custodySchedule.biweeklyAltParent2Days" class="day-chip parent2">
              {{ weekDays[dayValue].label }}
            </span>
            <span *ngIf="(custodySchedule.biweeklyAltParent2Days?.length ?? 0) === 0" class="empty-state">
              {{ t('custody.confirm.noDaysSelected') }}
            </span>
          </div>
        </div>

        <ion-note class="info-note">
          <ion-icon name="information-circle"></ion-icon>
          {{ t('custody.confirm.autoCreate') }}
        </ion-note>
      </ion-card-content>
    </ion-card>

    <ion-note class="info-note" *ngIf="requiresPartnerApproval && !isApprovalPending">
      {{ t('custody.confirm.pendingApproval', { name: awaitingParentName }) }}
    </ion-note>

    <div class="approval-actions" *ngIf="isAwaitingMyApproval">
      <ion-button expand="block" color="success" (click)="respondToPending(true)">
        <ion-icon name="checkmark" slot="start"></ion-icon>
        {{ t('custody.approval.approve') }}
      </ion-button>
      <ion-button expand="block" fill="outline" color="medium" (click)="respondToPending(false)">
        <ion-icon name="close" slot="start"></ion-icon>
        {{ t('custody.approval.reject') }}
      </ion-button>
    </div>

    <ion-button
      expand="block"
      color="primary"
      (click)="save()"
      *ngIf="!isApprovalPending">
      <ion-icon name="checkmark" slot="start"></ion-icon>
      {{ requiresPartnerApproval ? t('custody.confirm.sendForApproval') : t('custody.confirm.save') }}
    </ion-button>

    <ion-button expand="block" fill="outline" (click)="goToCustomize()" *ngIf="!isApprovalPending">
      <ion-icon name="create" slot="start"></ion-icon>
      {{ t('custody.confirm.edit') }}
    </ion-button>

    <ion-button 
      expand="block" 
      fill="clear" 
      color="danger" 
      (click)="deleteSchedule()"
      *ngIf="custodySchedule.id && !isApprovalPending">
      <ion-icon name="trash" slot="start"></ion-icon>
      {{ t('custody.confirm.delete') }}
    </ion-button>

    <ion-button
      expand="block"
      fill="clear"
      color="medium"
      *ngIf="isWaitingForOtherParent"
      (click)="cancelPendingRequest()">
      <ion-icon name="close-circle" slot="start"></ion-icon>
      {{ t('custody.approval.cancel') }}
    </ion-button>
  </div>

</ion-content>

<!-- Reusable approval banner template -->
<ng-template #approvalBanner>
  <div class="approval-banner" *ngIf="isApprovalPending">
    <ion-icon [name]="isWaitingForOtherParent ? 'hourglass-outline' : 'person-add-outline'"></ion-icon>
    <div>
      <h4 *ngIf="isWaitingForOtherParent">
        {{ t('custody.approval.waiting', { name: awaitingParentName }) }}
      </h4>
      <h4 *ngIf="isAwaitingMyApproval">
        {{ t('custody.approval.requested', { name: pendingApproval?.requestedByName || t('custody.approval.coParent') }) }}
      </h4>
      <p>
        <ng-container *ngIf="isWaitingForOtherParent">
          {{ step === 'customize' ? t('custody.approval.waitingNote', { name: awaitingParentName }) : t('custody.approval.canCancel') }}
        </ng-container>
        <ng-container *ngIf="isAwaitingMyApproval">
          {{ step === 'customize' ? t('custody.approval.requestedNote') : t('custody.approval.chooseAction') }}
        </ng-container>
      </p>
    </div>
  </div>
</ng-template>