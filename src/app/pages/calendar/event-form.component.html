<ion-header>
  <ion-toolbar>
    <ion-title>{{ isEditMode ? t('eventForm.title.edit') : t('eventForm.title.new') }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="cancel()">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <form [formGroup]="eventForm" class="form-shell">

    <section class="form-card hero-card">
      <div>
        <p class="eyebrow">{{ eventForm.get('isAllDay')?.value ? t('eventForm.allDayEvent') : t('eventForm.scheduledEvent') }}</p>
        <h1>{{ eventForm.get('title')?.value || t('eventForm.untitled') }}</h1>
        <p class="hero-date" *ngIf="eventForm.get('startDate')?.value as start">
          {{ start | date:'EEEE, d MMMM' }}
        </p>
      </div>
      <div class="hero-meta">
        <span *ngIf="eventForm.get('startTime')?.value && !eventForm.get('isAllDay')?.value">
          {{ eventForm.get('startTime')?.value }}
        </span>
        <span *ngIf="eventForm.get('location')?.value">
          {{ eventForm.get('location')?.value }}
        </span>
      </div>
    </section>

    <section class="form-card">
      <div class="section-heading">
        <p class="eyebrow">{{ t('eventForm.type.eyebrow') }}</p>
        <h2>{{ t('eventForm.type.heading') }}</h2>
      </div>
      <div class="event-type-grid">
        <button
          type="button"
          class="event-type-chip"
          *ngFor="let type of eventTypes"
          [class.selected]="eventForm.get('type')?.value === type.value"
          (click)="eventForm.patchValue({ type: type.value })">
          <ion-icon [name]="type.icon"></ion-icon>
          <span>{{ t('calendar.eventType.' + type.value) }}</span>
        </button>
      </div>
    </section>

    <section class="form-card fields-card">
      <div class="section-heading">
        <p class="eyebrow">{{ t('eventForm.details.eyebrow') }}</p>
        <h2>{{ t('eventForm.details.heading') }}</h2>
      </div>

      <ion-item [class.ion-invalid]="isFieldInvalid('title')">
        <ion-label position="stacked">{{ t('eventForm.field.titleRequired') }}</ion-label>
        <ion-input
          formControlName="title"
          type="text"
          [placeholder]="t('eventForm.field.titlePlaceholder')">
        </ion-input>
        <ion-note slot="error" *ngIf="isFieldInvalid('title')">
          {{ t('eventForm.field.titleError') }}
        </ion-note>
      </ion-item>

      <ion-item>
        <ion-label position="stacked">{{ t('eventForm.field.description') }}</ion-label>
        <ion-textarea
          formControlName="description"
          rows="3"
          [placeholder]="t('eventForm.field.descriptionPlaceholder')">
        </ion-textarea>
      </ion-item>

      <div class="form-section compact">
        <ion-label class="section-label">{{ t('eventForm.field.responsible') }}</ion-label>
        <ion-segment formControlName="parentId">
          <ion-segment-button
            *ngFor="let parent of parentOptions"
            [value]="parent.value">
            <ion-label>{{ parent.label }}</ion-label>
          </ion-segment-button>
        </ion-segment>
      </div>

      <div class="form-section compact" *ngIf="children.length">
        <ion-label class="section-label">{{ t('eventForm.field.childAssignment') }}</ion-label>
        <div class="child-chip-group">
          <button
            type="button"
            class="child-chip"
            [class.active]="!eventForm.value.childId"
            (click)="eventForm.get('childId')?.setValue(null)">
            {{ t('eventForm.field.noChildAssignment') }}
          </button>
          <button
            *ngFor="let child of children"
            type="button"
            class="child-chip"
            [class.active]="eventForm.value.childId === child"
            (click)="eventForm.get('childId')?.setValue(child)">
            {{ child }}
          </button>
        </div>
      </div>

      <ion-item lines="none" class="toggle-row">
        <ion-label>{{ t('eventForm.field.allDay') }}</ion-label>
        <ion-toggle formControlName="isAllDay" slot="end"></ion-toggle>
      </ion-item>

      <div class="datetime-grid" *ngIf="!eventForm.get('isAllDay')?.value">
        <ion-item class="datetime-item">
          <ion-label position="stacked">{{ t('eventForm.field.startTime') }}</ion-label>
          <ion-datetime-button datetime="event-start-time"></ion-datetime-button>
        </ion-item>
        <ion-modal keepContentsMounted="true">
          <ng-template>
            <ion-datetime
              id="event-start-time"
              formControlName="startTime"
              presentation="time"
              hourCycle="h23">
            </ion-datetime>
          </ng-template>
        </ion-modal>
        <ion-item class="datetime-item">
          <ion-label position="stacked">{{ t('eventForm.field.endTime') }}</ion-label>
          <ion-datetime-button datetime="event-end-time"></ion-datetime-button>
        </ion-item>
        <ion-modal keepContentsMounted="true">
          <ng-template>
            <ion-datetime
              id="event-end-time"
              formControlName="endTime"
              presentation="time"
              hourCycle="h23">
            </ion-datetime>
          </ng-template>
        </ion-modal>
      </div>

      <ion-item>
        <ion-label position="floating">{{ t('eventForm.field.location') }}</ion-label>
        <ion-input
          formControlName="location"
          type="text"
          [placeholder]="t('eventForm.field.locationPlaceholder')">
          <ion-icon name="location-outline" slot="start"></ion-icon>
        </ion-input>
      </ion-item>

      <div class="inline-fields">
        <ion-item>
          <ion-label>{{ t('eventForm.field.reminder') }}</ion-label>
          <ion-toggle formControlName="reminderEnabled"></ion-toggle>
        </ion-item>

        <ion-item>
          <ion-label>{{ t('eventForm.field.reminderWhen') }}</ion-label>
          <ion-select
            formControlName="reminderMinutes"
            interface="action-sheet"
            [disabled]="!eventForm.get('reminderEnabled')?.value">
            <ion-select-option
              *ngFor="let reminder of reminderOptions"
              [value]="reminder.value">
              {{ reminder.label }}
            </ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-label>{{ t('eventForm.field.color') }}</ion-label>
          <input
            type="color"
            formControlName="color"
            class="color-picker">
        </ion-item>
      </div>
    </section>

    <section class="form-card preview-card" *ngIf="eventForm.get('title')?.value">
      <div class="section-heading">
        <p class="eyebrow">{{ t('eventForm.preview.eyebrow') }}</p>
        <h2>{{ t('eventForm.preview.heading') }}</h2>
      </div>
      <div class="event-preview" [style.--preview-color]="eventForm.get('color')?.value">
        <div>
          <strong>{{ eventForm.get('title')?.value }}</strong>
          <p *ngIf="eventForm.get('description')?.value">
            {{ eventForm.get('description')?.value }}
          </p>
        </div>
        <div class="preview-details">
          <span *ngIf="getEventDay() as eventDay">
            <ion-icon name="calendar-outline"></ion-icon>
            {{ eventDay | date:'dd/MM/yyyy' }}
          </span>
          <span *ngIf="!eventForm.get('isAllDay')?.value && eventForm.get('startTime')?.value">
            <ion-icon name="time-outline"></ion-icon>
            {{ eventForm.get('startTime')?.value }}
          </span>
          <span *ngIf="eventForm.get('location')?.value">
            <ion-icon name="location-outline"></ion-icon>
            {{ eventForm.get('location')?.value }}
          </span>
        </div>
      </div>
    </section>

  </form>
</ion-content>

<ion-footer>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button 
        color="danger" 
        fill="clear"
        *ngIf="isEditMode"
        (click)="deleteEvent()">
        <ion-icon name="trash" slot="start"></ion-icon>
        {{ t('eventForm.action.delete') }}
      </ion-button>
    </ion-buttons>
    
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="cancel()">
        {{ t('eventForm.action.cancel') }}
      </ion-button>
      <ion-button 
        fill="solid" 
        color="primary"
        [disabled]="eventForm.invalid"
        (click)="save()">
        <ion-icon name="checkmark" slot="start"></ion-icon>
        {{ isEditMode ? t('eventForm.action.update') : t('eventForm.action.save') }}
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-footer>