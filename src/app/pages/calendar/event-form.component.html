<ion-header>
  <ion-toolbar>
    <ion-title>{{ isEditMode ? 'עריכת אירוע' : 'אירוע חדש' }}</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="cancel()">
        <ion-icon name="close" slot="icon-only"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <form [formGroup]="eventForm" class="form-shell">

    <section class="form-card hero-card">
      <div>
        <p class="eyebrow">{{ eventForm.get('isAllDay')?.value ? 'אירוע של יום שלם' : 'אירוע מתוזמן' }}</p>
        <h1>{{ eventForm.get('title')?.value || 'אירוע ללא שם' }}</h1>
        <p class="hero-date" *ngIf="eventForm.get('startDate')?.value as start">
          {{ start | date:'EEEE, d MMMM' }}
        </p>
      </div>
      <div class="hero-meta">
        <span *ngIf="eventForm.get('startTime')?.value && !eventForm.get('isAllDay')?.value">
          {{ eventForm.get('startTime')?.value }}
        </span>
        <span *ngIf="eventForm.get('location')?.value">
          {{ eventForm.get('location')?.value }}
        </span>
      </div>
    </section>

    <section class="form-card">
      <div class="section-heading">
        <p class="eyebrow">סוג אירוע</p>
        <h2>בחרו קטגוריה</h2>
      </div>
      <div class="event-type-grid">
        <button
          type="button"
          class="event-type-chip"
          *ngFor="let type of eventTypes"
          [class.selected]="eventForm.get('type')?.value === type.value"
          (click)="eventForm.patchValue({ type: type.value })">
          <ion-icon [name]="type.icon"></ion-icon>
          <span>{{ type.label }}</span>
        </button>
      </div>
    </section>

    <section class="form-card fields-card">
      <div class="section-heading">
        <p class="eyebrow">פרטים</p>
        <h2>גדירו את האירוע</h2>
      </div>

      <ion-item [class.ion-invalid]="isFieldInvalid('title')">
        <ion-label position="floating">כותרת *</ion-label>
        <ion-input
          formControlName="title"
          type="text"
          placeholder="לדוגמה: פגישה עם רופא שיניים">
        </ion-input>
        <ion-note slot="error" *ngIf="isFieldInvalid('title')">
          {{ getErrorMessage('title') }}
        </ion-note>
      </ion-item>

      <ion-item>
        <ion-label position="floating">תיאור</ion-label>
        <ion-textarea
          formControlName="description"
          rows="3"
          placeholder="פרטים נוספים על האירוע...">
        </ion-textarea>
      </ion-item>

      <div class="form-section compact">
        <ion-label class="section-label">מי אחראי?</ion-label>
        <ion-segment formControlName="parentId">
          <ion-segment-button
            *ngFor="let parent of parentOptions"
            [value]="parent.value">
            <ion-label>{{ parent.label }}</ion-label>
          </ion-segment-button>
        </ion-segment>
      </div>

      <ion-item lines="none" class="toggle-row">
        <ion-label>אירוע של יום שלם</ion-label>
        <ion-toggle formControlName="isAllDay" slot="end"></ion-toggle>
      </ion-item>

      <div class="datetime-grid">
        <ion-item class="datetime-item">
          <ion-label position="stacked">תאריך התחלה *</ion-label>
          <ion-datetime-button datetime="event-start-date"></ion-datetime-button>
        </ion-item>
        <ion-modal keepContentsMounted="true">
          <ng-template>
            <ion-datetime
              id="event-start-date"
              formControlName="startDate"
              presentation="date">
            </ion-datetime>
          </ng-template>
        </ion-modal>
        <ion-item class="datetime-item">
          <ion-label position="stacked">תאריך סיום</ion-label>
          <ion-datetime-button datetime="event-end-date"></ion-datetime-button>
        </ion-item>
        <ion-modal keepContentsMounted="true">
          <ng-template>
            <ion-datetime
              id="event-end-date"
              formControlName="endDate"
              presentation="date">
            </ion-datetime>
          </ng-template>
        </ion-modal>
      </div>

      <div class="datetime-grid" *ngIf="!eventForm.get('isAllDay')?.value">
        <ion-item class="datetime-item">
          <ion-label position="stacked">שעת התחלה</ion-label>
          <ion-datetime-button datetime="event-start-time"></ion-datetime-button>
        </ion-item>
        <ion-modal keepContentsMounted="true">
          <ng-template>
            <ion-datetime
              id="event-start-time"
              formControlName="startTime"
              presentation="time"
              hourCycle="h23">
            </ion-datetime>
          </ng-template>
        </ion-modal>
        <ion-item class="datetime-item">
          <ion-label position="stacked">שעת סיום</ion-label>
          <ion-datetime-button datetime="event-end-time"></ion-datetime-button>
        </ion-item>
        <ion-modal keepContentsMounted="true">
          <ng-template>
            <ion-datetime
              id="event-end-time"
              formControlName="endTime"
              presentation="time"
              hourCycle="h23">
            </ion-datetime>
          </ng-template>
        </ion-modal>
      </div>

      <ion-item>
        <ion-label position="floating">מיקום</ion-label>
        <ion-input
          formControlName="location"
          type="text"
          placeholder="לדוגמה: רחוב הרצל 10, תל אביב">
          <ion-icon name="location-outline" slot="start"></ion-icon>
        </ion-input>
      </ion-item>

      <div class="inline-fields">
        <ion-item>
          <ion-label>תזכורת</ion-label>
          <ion-select formControlName="reminderMinutes" interface="action-sheet">
            <ion-select-option
              *ngFor="let reminder of reminderOptions"
              [value]="reminder.value">
              {{ reminder.label }}
            </ion-select-option>
          </ion-select>
        </ion-item>

        <ion-item>
          <ion-label>צבע</ion-label>
          <input
            type="color"
            formControlName="color"
            class="color-picker">
        </ion-item>
      </div>
    </section>

    <section class="form-card preview-card" *ngIf="eventForm.get('title')?.value">
      <div class="section-heading">
        <p class="eyebrow">תצוגה מקדימה</p>
        <h2>כך זה יראה בלוח</h2>
      </div>
      <div class="event-preview" [style.--preview-color]="eventForm.get('color')?.value">
        <div>
          <strong>{{ eventForm.get('title')?.value }}</strong>
          <p *ngIf="eventForm.get('description')?.value">
            {{ eventForm.get('description')?.value }}
          </p>
        </div>
        <div class="preview-details">
          <span *ngIf="eventForm.get('startDate')?.value">
            <ion-icon name="calendar-outline"></ion-icon>
            {{ eventForm.get('startDate')?.value | date:'dd/MM/yyyy' }}
          </span>
          <span *ngIf="!eventForm.get('isAllDay')?.value && eventForm.get('startTime')?.value">
            <ion-icon name="time-outline"></ion-icon>
            {{ eventForm.get('startTime')?.value }}
          </span>
          <span *ngIf="eventForm.get('location')?.value">
            <ion-icon name="location-outline"></ion-icon>
            {{ eventForm.get('location')?.value }}
          </span>
        </div>
      </div>
    </section>

  </form>
</ion-content>

<ion-footer>
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-button 
        color="danger" 
        fill="clear"
        *ngIf="isEditMode"
        (click)="deleteEvent()">
        <ion-icon name="trash" slot="start"></ion-icon>
        מחק
      </ion-button>
    </ion-buttons>
    
    <ion-buttons slot="end">
      <ion-button fill="clear" (click)="cancel()">
        ביטול
      </ion-button>
      <ion-button 
        fill="solid" 
        color="primary"
        [disabled]="eventForm.invalid"
        (click)="save()">
        <ion-icon name="checkmark" slot="start"></ion-icon>
        {{ isEditMode ? 'עדכן' : 'שמור' }}
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-footer>
