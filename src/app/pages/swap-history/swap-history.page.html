<ion-header [translucent]="true">
  <ion-toolbar>
    <ion-buttons slot="start">
      <ion-back-button defaultHref="/tabs/home"></ion-back-button>
    </ion-buttons>
    <ion-title>היסטוריית בקשות</ion-title>
  </ion-toolbar>
</ion-header>

<ion-content [fullscreen]="true">
  <div class="history-shell">
    @if (isLoading) {
      <div class="state-block">
        <ion-spinner name="crescent"></ion-spinner>
        <p>טוען בקשות...</p>
      </div>
    } @else {
      <section class="panel filters-card">
        <ion-segment [(ngModel)]="requestFilter" class="requests-segment">
          <ion-segment-button value="all">
            <ion-label>
              כל הבקשות
              <ion-badge color="primary">{{ swapRequests.length }}</ion-badge>
            </ion-label>
          </ion-segment-button>
          <ion-segment-button [value]="SwapRequestStatus.PENDING">
            <ion-label>
              ממתינות
              <ion-badge color="warning">{{ getStatusCount(SwapRequestStatus.PENDING) }}</ion-badge>
            </ion-label>
          </ion-segment-button>
          <ion-segment-button [value]="SwapRequestStatus.APPROVED">
            <ion-label>
              אושרו
              <ion-badge color="success">{{ getStatusCount(SwapRequestStatus.APPROVED) }}</ion-badge>
            </ion-label>
          </ion-segment-button>
          <ion-segment-button [value]="SwapRequestStatus.REJECTED">
            <ion-label>
              נדחו
              <ion-badge color="danger">{{ getStatusCount(SwapRequestStatus.REJECTED) }}</ion-badge>
            </ion-label>
          </ion-segment-button>
        </ion-segment>
      </section>

      <section class="panel history-panel">
        @if (filteredSwapRequests.length > 0) {
          <ion-accordion-group multiple="true" class="history-accordion">
            <ion-accordion
              *ngFor="let request of filteredSwapRequests"
              [value]="request.id"
              class="history-accordion-card">
              <ion-item
                slot="header"
                lines="none"
                detail="false"
                class="history-header">
                <ion-label>
                  <div class="parties">
                    <strong>{{ request.requestedByName }}</strong>
                    <ion-icon name="swap-horizontal"></ion-icon>
                    <strong>{{ request.requestedToName }}</strong>
                  </div>
                  <p class="header-dates">
                    {{ formatDate(request.originalDate) }} → {{ formatDate(request.proposedDate) }}
                  </p>
                </ion-label>
                <ion-badge slot="end" [color]="getRequestStatusColor(request.status)">
                  {{ getRequestStatusLabel(request.status) }}
                </ion-badge>
                <ion-icon slot="end" class="chevron" name="chevron-down-outline"></ion-icon>
              </ion-item>

              <div slot="content" class="history-body">
                <ion-list class="history-list" lines="none">
                  <ion-item lines="none" class="timeline-row">
                    <ion-label>
                      <div class="timeline">
                        <span class="label">מקורי</span>
                        <strong>{{ formatDate(request.originalDate) }}</strong>
                      </div>
                    </ion-label>
                    <ion-icon name="chevron-back-outline"></ion-icon>
                    <ion-label class="ion-text-right">
                      <div class="timeline">
                        <span class="label">מוצע</span>
                        <strong>{{ formatDate(request.proposedDate) }}</strong>
                      </div>
                    </ion-label>
                  </ion-item>
                </ion-list>

                @if (request.reason) {
                  <p class="request-reason">
                    {{ request.reason }}
                  </p>
                }

                <ion-note class="request-meta">
                  נשלחה ב־{{ formatDate(request.createdAt) }}
                </ion-note>
                @if (request.respondedAt) {
                  <ion-note class="request-meta">
                    עודכנה ב־{{ formatDate(request.respondedAt) }}
                  </ion-note>
                }

                @if (request.status !== SwapRequestStatus.PENDING && request.responseNote) {
                  <div class="response-note">
                    <ion-icon name="chatbubbles-outline"></ion-icon>
                    <span>{{ request.responseNote }}</span>
                  </div>
                }

                @if (canRespondToRequest(request)) {
                  <ion-textarea
                    class="request-note-input"
                    placeholder="הוסף הערה להורה השני (אופציונלי)"
                    autoGrow="true"
                    [rows]="2"
                    [maxlength]="300"
                    [name]="'history-note-' + request.id"
                    [(ngModel)]="requestNotes[request.id]">
                  </ion-textarea>

                  <div class="request-actions">
                    <ion-button
                      color="success"
                      expand="block"
                      (click)="handleRequestAction(request, SwapRequestStatus.APPROVED)">
                      <ion-icon slot="start" name="checkmark-circle"></ion-icon>
                      אישור
                    </ion-button>
                    <ion-button
                      color="danger"
                      expand="block"
                      fill="outline"
                      (click)="handleRequestAction(request, SwapRequestStatus.REJECTED)">
                      <ion-icon slot="start" name="close-circle"></ion-icon>
                      דחייה
                    </ion-button>
                  </div>
                }

                @if (canCancelRequest(request)) {
                  <ion-button
                    expand="block"
                    fill="outline"
                    color="medium"
                    class="request-cancel-button"
                    (click)="handleRequestAction(request, SwapRequestStatus.CANCELLED)">
                    <ion-icon slot="start" name="close-circle-outline"></ion-icon>
                    בטל בקשה
                  </ion-button>
                }
              </div>
            </ion-accordion>
          </ion-accordion-group>
        } @else {
          <div class="empty-card">
            <ion-icon name="time-outline"></ion-icon>
            <p>אין בקשות החלפה להצגה</p>
          </div>
        }
      </section>
    }
  </div>
</ion-content>
